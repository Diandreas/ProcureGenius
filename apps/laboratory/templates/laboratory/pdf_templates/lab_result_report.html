{% extends 'pdf_base.html' %}
{% load i18n %}

{% block title %}Lab Result - {{ lab_order.order_number }}{% endblock %}

{% block extra_css %}
<style>
    .flag-high {
        color: #dc2626;
        font-weight: 700;
    }

    .flag-low {
        color: #2563eb;
        font-weight: 700;
    }

    .flag-normal {
        color: #059669;
    }

    .category-row td {
        background-color: #f3f4f6;
        font-weight: 700;
        color: #374151;
        padding-top: 8px;
        padding-bottom: 8px;
    }

    .notes {
        margin-top: 15px;
        padding: 8px;
        background-color: #fffbeb;
        border: 1px solid #fcd34d;
        border-radius: 4px;
        font-size: 8pt;
        color: #92400e;
    }
</style>
{% endblock %}

{% block content %}
<div class="doc-title text-center">RÉSULTATS DE LABORATOIRE</div>

<div class="info-grid">
    <div class="info-col" style="width: 50%;">
        <div class="info-label">Patient</div>
        <div class="info-value">
            <span class="text-bold" style="font-size: 10pt;">{{ patient.name }}</span><br>
            {{ patient.gender|default:"" }} |
            {% if patient.date_of_birth %}
            {{ patient.get_age }} ans
            {% else %}
            N/A
            {% endif %}<br>
            ID: {{ patient.patient_number|default:"-" }}
        </div>

        <div class="info-label" style="margin-top: 8px;">Médecin Prescripteur</div>
        <div class="info-value">
            {% if lab_order.ordered_by %}
            Dr. {{ lab_order.ordered_by.get_full_name }}
            {% else %}
            -
            {% endif %}
        </div>
    </div>
    <div class="info-col" style="width: 50%;">
        <div class="info-label">Détails Commande</div>
        <div class="info-value">
            N°: {{ lab_order.order_number }}<br>
            Date: {{ lab_order.order_date|date:"d/m/Y H:i" }}<br>
            Priorité: {{ lab_order.get_priority_display }}
        </div>
    </div>
</div>

<table class="compact-table">
    <thead>
        <tr>
            <th style="width: 40%">Examen / Test</th>
            <th style="width: 20%">Résultat</th>
            <th style="width: 10%">Unités</th>
            <th style="width: 15%">Valeurs Réf.</th>
            <th style="width: 15%">Antérieur</th>
            <th style="width: 10%; text-align: right;">Flag</th>
        </tr>
    </thead>
    <tbody>
        {% regroup items by item.lab_test.category as category_list %}

        {% for category in category_list %}
        <tr class="category-row">
            <td colspan="6">
                {% if category.grouper %}
                {{ category.grouper.name }}
                {% else %}
                {% trans "Other Tests" %}
                {% endif %}
            </td>
        </tr>
        {% for item_data in category.list %}
        {% with item=item_data.item previous=item_data.previous_result prev_date=item_data.previous_date %}
        <tr>
            <td style="padding-left: 15px;">{{ item.lab_test.name }}</td>
            <td>
                <strong>{{ item.result_value|default:"-" }}</strong>
            </td>
            <td>{{ item.lab_test.unit_of_measurement|default:"-" }}</td>
            <td>
                {% if patient.gender == 'M' and item.lab_test.normal_range_male %}
                {{ item.lab_test.normal_range_male }}
                {% elif patient.gender == 'F' and item.lab_test.normal_range_female %}
                {{ item.lab_test.normal_range_female }}
                {% else %}
                {{ item.lab_test.normal_range_general|default:"-" }}
                {% endif %}
            </td>
            <td>
                {% if previous %}
                {{ previous }} <br><span style="font-size: 6pt; color: #6b7280;">({{ prev_date }})</span>
                {% else %}
                /
                {% endif %}
            </td>
            <td style="text-align: right;">
                {% if item.is_abnormal %}
                <span class="flag-high">ANORMAL</span>
                {% endif %}
            </td>
        </tr>
        {% endwith %}
        {% endfor %}
        {% empty %}
        <tr>
            <td colspan="6" class="text-center" style="padding: 15px; color: #6b7280;">Aucun résultat disponible</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if lab_order.clinical_notes %}
<div class="notes" style="background-color: #eff6ff; border-color: #3b82f6; color: #1e40af;">
    <strong>Diagnostic du Médecin / Renseignements Cliniques :</strong><br>
    {{ lab_order.clinical_notes|linebreaksbr }}
</div>
{% endif %}

{% if lab_order.biologist_diagnosis %}
<div class="notes"
    style="background-color: #f0fdf4; border: 2px solid #22c55e; color: #166534; margin-top: 15px; padding: 12px;">
    <div
        style="font-size: 10pt; font-weight: 800; text-transform: uppercase; margin-bottom: 5px; border-bottom: 1px solid #22c55e; padding-bottom: 3px;">
        Conclusion / Diagnostic du Biologiste :
    </div>
    <div style="font-size: 11pt; line-height: 1.5; font-weight: 500;">
        {{ lab_order.biologist_diagnosis|linebreaksbr }}
    </div>
</div>
{% endif %}

<div style="margin-top: 40px; display: table; width: 100%;">
    <div style="display: table-cell; width: 50%;">
        <div class="info-label">Validé par :</div>
        {% if lab_order.results_verified_by %}
        <div style="font-weight: bold; margin-bottom: 5px;">{{ lab_order.results_verified_by.get_full_name }}</div>
        {% endif %}
        <div
            style="margin-top: {% if lab_order.results_verified_by %}5px{% else %}30px{% endif %}; border-top: 1px dotted #9ca3af; width: 180px; padding-top: 4px; font-size: 8pt; color: #6b7280;">
            Signature Valideur
        </div>
    </div>
    <div style="display: table-cell; width: 50%; text-align: right;">
        <div class="info-label">Date d'édition:</div>
        <div class="info-value">{% now "d/m/Y H:i" %}</div>
    </div>
</div>
{% endblock %}