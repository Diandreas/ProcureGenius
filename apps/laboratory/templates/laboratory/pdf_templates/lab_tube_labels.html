<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Étiquettes Tubes - {{ lab_order.order_number }}</title>
    <style>
        @page {
            size: 100mm 150mm;
            margin: 0;
        }

        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            margin: 0;
            padding: 0;
        }

        .label-wrapper {
            width: 100mm;
            height: 150mm;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            page-break-after: always;
            padding-left: -5mm;
            margin-left: -8mm;
        }

        .label-wrapper:last-child {
            page-break-after: auto;
        }

        .label {
            width: 60mm;
            height: 40mm;
            padding: 2mm 3mm;
            box-sizing: border-box;
            display: block;
            position: relative;
            background: white;
        }

        .label-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.2mm;
            padding-bottom: 0.2mm;
            border-bottom: 1px solid #000;
        }

        .container-type {
            font-size: 7pt;
            font-weight: bold;
            color: #000;
            text-transform: uppercase;
        }

        .test-code {
            font-size: 7pt;
            color: #000;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .test-name {
            font-size: 8pt;
            font-weight: bold;
            color: #000;
            margin-bottom: 0.5mm;
            line-height: 1.1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .patient-info {
            font-size: 7pt;
            color: #000;
            margin-bottom: 1mm;
            line-height: 1.1;
        }

        .patient-name {
            font-weight: bold;
            font-size: 7.5pt;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .qrcode-container {
            text-align: center;
            margin: 0.5mm 0;
        }

        .qrcode-image {
            width: 15mm;
            height: 15mm;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }

        .qrcode-text {
            font-size: 6pt;
            color: #000;
            margin-top: 0.2mm;
            font-family: 'Courier New', monospace;
        }

        .order-info {
            font-size: 6pt;
            color: #000;
            text-align: center;
            margin-top: 0.1mm;
            padding-top: 0.2mm;
            border-top: 1px solid #ccc;
        }

        .sample-type {
            font-size: 6.5pt;
            color: #000;
            font-weight: 500;
            margin-bottom: 0.5mm;
        }
    </style>
</head>

<body>
    {% if not labels %}
    <div class="label-wrapper">
        <div class="label">
            <div style="padding: 5mm; text-align: center; font-size: 10pt;">
                ERREUR : Aucune étiquette à imprimer
            </div>
        </div>
    </div>
    {% endif %}

    {% for label in labels %}
    <div class="label-wrapper">
        <div class="label">
            <div class="label-header">
                <span class="container-type">TUBE #{{ label.tube_number }} - {{ label.container_type }}</span>
                <span class="test-code">{{ label.tests_count }} test{{ label.tests_count|pluralize }}</span>
            </div>

            <!-- Liste des tests sur ce tube (noms séparés par virgules) -->
            <div style="margin-bottom: 1mm; font-size: 7pt; line-height: 1.3; color: #000;">
                {% for test in label.tests %}{{ test.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
            </div>

            {% if label.sample_type %}
            <div class="sample-type" style="margin-bottom: 0.5mm;">
                Échantillon: {{ label.sample_type }}
            </div>
            {% endif %}

            <div class="patient-info">
                <div class="patient-name">{{ label.patient_name }}</div>
                <div>
                    N°: {{ label.patient_number }}
                    {% if label.patient_dob %}
                    | {{ label.patient_dob|date:"d/m/Y" }}
                    {% endif %}
                </div>
            </div>

            <div class="qrcode-container">
                {% if label.qrcode_base64 %}
                <img src="data:image/png;base64,{{ label.qrcode_base64 }}" class="qrcode-image" alt="QR Code">
                {% endif %}
                <div class="qrcode-text">{{ label.order_number }}</div>
            </div>

            <div class="order-info">
                Date: {{ label.order_date|date:"d/m/y H:i" }}
            </div>
        </div>
    </div>
    {% endfor %}
</body>

</html>