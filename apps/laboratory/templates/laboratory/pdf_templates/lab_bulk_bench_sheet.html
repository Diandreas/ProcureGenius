{% load i18n %}
<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Fiches de Paillasse Groupées</title>
    <style>
        @page {
            size: A4;
            margin: 10mm;

            @bottom-center {
                content: "Page " counter(page) " / " counter(pages);
                font-size: 7.5pt;
                color: #999;
            }
        }

        body {
            font-family: 'Helvetica', 'Arial', sans-serif;
            font-size: 9pt;
            line-height: 1.3;
            color: #111;
            margin: 0;
            padding: 0;
        }

        .page-break {
            page-break-after: always;
        }

        .no-break {
            page-break-inside: avoid;
        }

        /* Index Page */
        .index-title {
            text-align: center;
            margin-top: 50px;
            font-size: 20pt;
            color: {{ organization.brand_color|default:"#2563eb" }};
        }

        .index-meta {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
        }

        table.index-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table.index-table th {
            background: #f1f5f9;
            padding: 10px;
            border: 1px solid #e2e8f0;
            text-align: left;
        }

        table.index-table td {
            padding: 8px 10px;
            border: 1px solid #e2e8f0;
        }

        /* Sheet Styles */
        .sheet-container {
            padding: 5mm 0;
        }

        .sheet-header {
            display: table;
            width: 100%;
            border-bottom: 2px solid #2563eb;
            margin-bottom: 8mm;
            padding-bottom: 3mm;
        }

        .header-left {
            display: table-cell;
            vertical-align: bottom;
        }

        .header-right {
            display: table-cell;
            text-align: right;
            vertical-align: bottom;
            font-size: 7.5pt;
            color: #666;
        }

        .title-box {
            display: table;
            width: 100%;
            background: #f8fafc;
            padding: 3mm;
            border-radius: 4px;
            margin-bottom: 5mm;
        }

        .title-left {
            display: table-cell;
            font-size: 14pt;
            font-weight: 800;
            color: {{ organization.brand_color|default:"#2563eb" }};
        }

        .title-right {
            display: table-cell;
            text-align: right;
            font-weight: 700;
            color: #64748b;
        }

        .patient-summary {
            display: table;
            width: 100%;
            background: #fff;
            border: 1px solid #e2e8f0;
            padding: 3mm;
            border-radius: 5px;
            margin-bottom: 6mm;
        }

        .summary-cell {
            display: table-cell;
            width: 33%;
            vertical-align: top;
        }

        .summary-label {
            font-size: 7pt;
            color: #94a3b8;
            text-transform: uppercase;
            font-weight: 700;
        }

        .summary-value {
            font-size: 9.5pt;
            font-weight: 700;
            display: block;
        }

        table.work-table {
            width: 100%;
            border-collapse: collapse;
        }

        table.work-table th {
            background: #2563eb;
            color: white;
            padding: 6px 10px;
            font-size: 8pt;
            text-align: left;
            text-transform: uppercase;
        }

        table.work-table td {
            padding: 9px 10px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: top;
        }

        .cat-row {
            background: #f1f5f9;
            font-weight: 800;
            color: {{ organization.brand_color|default:"#2563eb" }};
            font-size: 8.5pt;
        }

        .result-box {
            border: 1px solid #cbd5e1;
            height: 7mm;
            background: #fff;
            width: 100%;
        }

        .footer-sigs {
            margin-top: 10mm;
            display: table;
            width: 100%;
        }

        .sig-box {
            display: table-cell;
            width: 50%;
            text-align: center;
        }

        .sig-line {
            border-top: 1px solid #94a3b8;
            margin: 8mm 15mm 0;
            padding-top: 1mm;
            font-size: 7.5pt;
            color: #64748b;
        }
    </style>
</head>

<body>
    <!-- 1. Index Page -->
    <div class="page-break">
        <h1 class="index-title">FICHES DE PAILLASSE GROUPÉES</h1>
        <div class="index-meta">
            Date : {% now "d/m/Y H:i" %}<br>
            Total Demandes : {{ orders|length }}
        </div>

        <table class="index-table">
            <thead>
                <tr>
                    <th>{% trans "Order #" %}</th>
                    <th>{% trans "Patient" %}</th>
                    <th>{% trans "ID" %}</th>
                    <th>{% trans "Items" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr>
                    <td><strong>{{ order.order_number }}</strong></td>
                    <td>{{ order.patient.full_name }}</td>
                    <td>{{ order.patient.patient_id }}</td>
                    <td>{{ order.items.count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div style="margin-top: 100px; text-align: center; font-size: 8pt; color: #999;">
            {{ organization.name }} - {% trans "Laboratory Management System" %}
        </div>
    </div>

    <!-- 2. Individual Sheets -->
    {% for order in orders %}
    <div class="sheet-container {% if not forloop.last %}page-break{% endif %}">
        <div class="sheet-header">
            <div class="header-left">
                {% if logo_base64 %}
                <img src="{{ logo_base64 }}" style="max-height: 40px; width: auto;">
                {% else %}
                <strong style="font-size: 14pt; color: {{ organization.brand_color|default:" #2563eb" }};">{{
                    organization.name }}</strong>
                {% endif %}
            </div>
            <div class="header-right">
                {{ organization.address|default:""|striptags }}<br>
                {{ organization.phone|default:"" }}
            </div>
        </div>

        <div class="title-box">
            <div class="title-left">FICHE DE PAILLASSE</div>
            <div class="title-right">#{{ order.order_number }}</div>
        </div>

        <div class="patient-summary">
            <div class="summary-cell">
                <span class="summary-label">Patient :</span>
                <span class="summary-value">{{ order.patient.full_name }}</span>
                <span style="font-size: 8pt; color: #64748b;">{{ order.patient.patient_id }}</span>
            </div>
            <div class="summary-cell">
                <span class="summary-label">Sexe / Âge :</span>
                <span class="summary-value">{{ order.patient.get_gender_display }} / {{ order.patient.age }} ans</span>
            </div>
            <div class="summary-cell" style="text-align: right;">
                <span class="summary-label">Prélèvement :</span>
                <span class="summary-value">{{ order.created_at|date:"d/m/Y H:i" }}</span>
                {% if order.is_urgent %}<span style="color: #dc2626; font-weight: 800;">!!! URGENT !!!</span>{% endif %}
            </div>
        </div>

        <table class="work-table">
            <thead>
                <tr>
                    <th width="40%">Analyse</th>
                    <th width="15%">Échantillon</th>
                    <th width="30%">Résultat Brut</th>
                    <th width="15%">Visa</th>
                </tr>
            </thead>
            <tbody>
                {% regroup order.items.all by lab_test.category as category_list %}
                {% for category in category_list %}
                <tr class="cat-row">
                    <td colspan="4">{{ category.grouper.name|default:"Général" }}</td>
                </tr>
                {% for item in category.list %}
                <tr>
                    <td>
                        <div style="font-weight: 700;">{{ item.lab_test.name }}{% if item.lab_test.test_code %} <span style="font-size: 7.5pt; color: #666; font-weight: 400;">[{{ item.lab_test.test_code }}]</span>{% endif %}</div>
                    </td>
                    <td>
                        <small>{{ item.lab_test.get_sample_type_display }}{% if item.lab_test.unit_of_measurement %} <span style="color: #666;">({{ item.lab_test.unit_of_measurement }})</span>{% endif %}</small>
                    </td>
                    <td>
                        <div class="result-box"></div>
                    </td>
                    <td>
                        <div class="result-box"></div>
                    </td>
                </tr>
                {% endfor %}
                {% endfor %}
            </tbody>
        </table>

        <div class="footer-sigs">
            <div class="sig-box">
                <span class="summary-label">Date & Heure Début:</span>
                <div class="sig-line">Technicien / Analyste</div>
            </div>
            <div class="sig-box">
                <span class="summary-label">Heure Fin & Validation:</span>
                <div class="sig-line">Biologiste / Superviseur</div>
            </div>
        </div>
    </div>
    {% endfor %}
</body>

</html>