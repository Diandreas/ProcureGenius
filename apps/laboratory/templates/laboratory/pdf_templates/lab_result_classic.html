<!DOCTYPE html>
<html lang="{{ language }}">

<head>
    <meta charset="UTF-8">
    <title>Lab Result - {{ order.order_number }}</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;

            @bottom-center {
                content: "Page " counter(page) " / " counter(pages);
                font-family: 'Helvetica', sans-serif;
                font-size: 9pt;
                color: #666;
            }
        }

        body {
            font-family: 'Helvetica', sans-serif;
            font-size: 10pt;
            line-height: 1.4;
            color: #333;
        }

        .header {
            width: 100%;
            margin-bottom: 30px;
            border-bottom: 2px solid {{ brand_color|default:"#2563eb" }};
            padding-bottom: 10px;
        }

        .logo {
            max-height: 60px;
        }

        .org-info {
            text-align: right;
            font-size: 9pt;
            color: #555;
        }

        .org-name {
            font-size: 14pt;
            font-weight: bold;
            color: {{ brand_color|default:"#2563eb" }};
            margin-bottom: 5px;
        }

        .title-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .doc-title {
            font-size: 18pt;
            font-weight: bold;
            text-transform: uppercase;
            color: {{ brand_color|default:"#2563eb" }};
            letter-spacing: 2px;
        }

        .info-grid {
            display: table;
            width: 100%;
            margin-bottom: 30px;
            background-color: #f9fafb;
            border-radius: 5px;
            padding: 15px;
        }

        .info-col {
            display: table-cell;
            width: 50%;
            vertical-align: top;
        }

        .info-label {
            font-weight: bold;
            color: #666;
            font-size: 8pt;
            text-transform: uppercase;
        }

        .info-value {
            margin-bottom: 10px;
            font-weight: 500;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        th {
            background-color: {{ brand_color|default:"#2563eb" }};
            color: white;
            text-align: left;
            padding: 8px;
            font-size: 9pt;
            text-transform: uppercase;
        }

        td {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .category-row {
            background-color: #f0f0f0;
            font-weight: bold;
        }

        .flag-high {
            color: #dc2626;
            font-weight: bold;
        }

        .flag-low {
            color: #2563eb;
            font-weight: bold;
        }

        .flag-normal {
            color: #059669;
        }

        .footer {
            margin-top: 50px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
            display: table;
            width: 100%;
        }

        .signature-box {
            display: table-cell;
            width: 50%;
            vertical-align: top;
        }

        .qr-code {
            position: absolute;
            top: 2cm;
            right: 0;
            width: 60px;
        }

        .notes {
            margin-top: 20px;
            padding: 10px;
            background-color: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 4px;
            font-size: 9pt;
        }
    </style>
</head>

<body>
    <div class="header">
        <table style="width: 100%; border: none; margin: 0;">
            <tr>
                <td style="width: 50%; border: none;">
                    {% if logo_base64 %}
                    <img src="{{ logo_base64 }}" class="logo" alt="Logo">
                    {% else %}
                    <div class="org-name">{{ organization.name }}</div>
                    {% endif %}
                </td>
                <td style="width: 50%; border: none; text-align: right;">
                    <div class="org-info">
                        <strong>{{ organization.name }}</strong><br>
                        {{ organization.address }}<br>
                        {{ organization.phone }} | {{ organization.email }}
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <div class="title-section">
        <div class="doc-title">RÉSULTATS DE LABORATOIRE</div>
    </div>

    <div class="info-grid">
        <div class="info-col">
            <div class="info-label">Patient</div>
            <div class="info-value">
                {{ patient.name }}<br>
                {{ patient.gender|default:"" }} | {% if patient.date_of_birth %}{{ patient.get_age }} ans{% else %}N/A{%
                endif %}<br>
                ID: {{ patient.patient_number|default:"-" }}
            </div>

            <div class="info-label">Médecin Prescripteur</div>
            <div class="info-value">
                {% if order.ordered_by %}
                Dr. {{ order.ordered_by.get_full_name }}
                {% else %}
                -
                {% endif %}
            </div>
        </div>
        <div class="info-col">
            <div class="info-label">Détails Commande</div>
            <div class="info-value">
                N°: {{ order.order_number }}<br>
                Date: {{ order.order_date|date:"d/m/Y H:i" }}<br>
                Priorité: {{ order.get_priority_display }}
            </div>

            {% if qr_code_base64 %}
            <div style="margin-top: 10px;">
                <img src="{{ qr_code_base64 }}" width="80" alt="QR">
            </div>
            {% endif %}
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 40%">Examen / Test</th>
                <th style="width: 20%">Résultat</th>
                <th style="width: 10%">Unités</th>
                <th style="width: 20%">Valeurs Réf.</th>
                <th style="width: 10%">Flag</th>
            </tr>
        </thead>
        <tbody>
            {% regroup items by lab_test.category as category_list %}

            {% for category in category_list %}
            <tr class="category-row">
                <td colspan="5">{% if category.grouper %}{{ category.grouper.name }}{% else %}Autres Tests{% endif %}
                </td>
            </tr>
            {% for item in category.list %}
            <tr>
                <td style="padding-left: 20px;">{{ item.lab_test.name }}</td>
                <td>
                    <strong>{{ item.result_value|default:"-" }}</strong>
                </td>
                <td>{{ item.lab_test.unit_of_measurement|default:"-" }}</td>
                <td>
                    {% if patient.gender == 'M' and item.lab_test.normal_range_male %}
                    {{ item.lab_test.normal_range_male }}
                    {% elif patient.gender == 'F' and item.lab_test.normal_range_female %}
                    {{ item.lab_test.normal_range_female }}
                    {% else %}
                    {{ item.lab_test.normal_range_general|default:"-" }}
                    {% endif %}
                </td>
                <td>
                    {% if item.is_abnormal %}
                    <span class="flag-high">ANORMAL</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% empty %}
            <tr>
                <td colspan="5" style="text-align: center; color: #666;">Aucun résultat disponible</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if order.clinical_notes %}
    <div class="notes">
        <strong>Notes cliniques:</strong> {{ order.clinical_notes }}
    </div>
    {% endif %}

    <div class="footer">
        <div class="signature-box">
            <div class="info-label">Validé par:</div>
            <div style="margin-top: 40px; border-top: 1px dotted #ccc; width: 200px;">
                Signature Technicien / Biologiste
            </div>
        </div>
        <div class="signature-box" style="text-align: right;">
            <div class="info-label">Date d'édition:</div>
            <div>{% now "d/m/Y H:i" %}</div>
        </div>
    </div>
</body>

</html>