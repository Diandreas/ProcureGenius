<!DOCTYPE html>
<html lang="{{ language }}">

<head>
    <meta charset="UTF-8">
    <title>Lab Result - {{ order.order_number }}</title>
    <style>
        @page {
            size: A4;
            margin: 1cm;

            @bottom-right {
                content: "Page " counter(page) " / " counter(pages);
                font-family: 'Helvetica', sans-serif;
                font-size: 8pt;
                color: #888;
            }
        }

        body {
            font-family: 'Helvetica', sans-serif;
            font-size: 9pt;
            line-height: 1.3;
            color: #111;
        }

        /* Minimalist Modern Header */
        .header-container {
            display: table;
            width: 100%;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #000;
            padding-bottom: 0.5rem;
        }

        .header-left {
            display: table-cell;
            width: 60%;
            vertical-align: middle;
        }

        .header-right {
            display: table-cell;
            width: 40%;
            text-align: right;
            vertical-align: middle;
        }

        .org-name {
            font-size: 14pt;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 2px;
        }

        .org-details {
            font-size: 8pt;
            color: #444;
            line-height: 1.2;
        }

        .doc-type {
            font-size: 14pt;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #000;
            margin-bottom: 5px;
        }

        /* Patient Info Grid */
        .info-grid {
            display: table;
            width: 100%;
            margin-bottom: 2rem;
        }

        .info-column {
            display: table-cell;
            width: 33%;
            vertical-align: top;
            padding-right: 15px;
        }

        .info-label {
            font-size: 7pt;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 2px;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 10pt;
            font-weight: 600;
            margin-bottom: 10px;
        }

        /* Minimalist Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th {
            text-align: left;
            font-size: 8pt;
            text-transform: uppercase;
            color: #666;
            border-bottom: 2px solid #000;
            padding: 8px 5px;
            font-weight: 700;
        }

        td {
            padding: 8px 5px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }

        .category-header {
            background-color: #f8f8f8;
            font-weight: 800;
            font-size: 9pt;
            text-transform: uppercase;
            padding-top: 15px;
            padding-bottom: 5px;
        }

        .result-value {
            font-weight: 700;
            font-size: 10pt;
        }

        .unit {
            font-size: 8pt;
            color: #555;
        }

        .range {
            font-size: 8pt;
            color: #555;
        }

        .abnormal {
            color: #dc2626;
            /* Red for abnormal */
        }

        .flag-marker {
            font-weight: 900;
            color: #dc2626;
            font-size: 8pt;
            border: 1px solid #dc2626;
            padding: 1px 4px;
            border-radius: 2px;
        }

        .footer-section {
            margin-top: 3rem;
            page-break-inside: avoid;
        }

        .signature-grid {
            display: table;
            width: 100%;
        }

        .signature-box {
            display: table-cell;
            width: 33%;
            vertical-align: top;
        }

        .signature-line {
            margin-top: 40px;
            border-top: 1px solid #ccc;
            width: 80%;
            padding-top: 5px;
            font-size: 8pt;
        }

        /* Compact layout adjustments */
        .sm-text {
            font-size: 8pt;
            color: #666;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="header-container">
        <div class="header-left">
            {% if logo_base64 %}
            <img src="{{ logo_base64 }}" style="max-height: 50px; margin-bottom: 10px;">
            {% else %}
            <div class="org-name">{{ organization.name }}</div>
            {% endif %}
            <div class="org-details">
                {{ organization.address }}<br>
                {{ organization.phone }} &bull; {{ organization.email }}
            </div>
        </div>
        <div class="header-right">
            <div class="doc-type">Résultats d'Analyses</div>
            <div class="org-details">
                <strong>Ordre #{{ order.order_number }}</strong><br>
                Date: {{ order.order_date|date:"d/m/Y H:i" }}
            </div>
            {% if qr_code_base64 %}
            <img src="{{ qr_code_base64 }}" width="60" style="margin-top: 5px;">
            {% endif %}
        </div>
    </div>

    <!-- Patient Info -->
    <div class="info-grid">
        <div class="info-column">
            <div class="info-label">Patient</div>
            <div class="info-value">
                {{ patient.name }}
            </div>
            <div class="sm-text">
                {{ patient.gender }}, {% if patient.date_of_birth %}{{ patient.get_age }} Ans{% else %}-{% endif %}<br>
                ID: {{ patient.patient_number|default:"-" }}
            </div>
        </div>
        <div class="info-column">
            <div class="info-label">Médecin / Renseignements</div>
            <div class="info-value" style="font-size: 8pt; line-height: 1.2;">
                {% if order.ordered_by %}Dr. {{ order.ordered_by.get_full_name }}{% else %}-{% endif %}
            </div>
            {% if order.clinical_notes %}
            <div class="sm-text" style="color: #1e40af; background: #eff6ff; padding: 4px; border-radius: 2px; margin-top: 4px;">
                <strong>Renseignements :</strong> {{ order.clinical_notes|truncatechars:150 }}
            </div>
            {% endif %}
        </div>
        <div class="info-column">
            <div class="info-label">Statut</div>
            <div class="info-value">
                {% if order.status == 'completed' or order.status == 'results_delivered' %}Validé{% else %}Provisoire{%
                endif %}
            </div>
            <div class="sm-text">
                Imprimé le: {% now "d/m/Y H:i" %}
            </div>
        </div>
    </div>

    <!-- Results Table -->
    <table>
        <thead>
            <tr>
                <th width="35%">Examen</th>
                <th width="15%">Résultat</th>
                <th width="10%">Unité</th>
                <th width="20%">Réf. Values</th>
                <th width="15%">Antérieurs</th>
                <th width="5%">Flag</th>
            </tr>
        </thead>
        <tbody>
            {% regroup items by item.lab_test.category as category_list %}

            {% for category in category_list %}
            <tr>
                <td colspan="6" class="category-header">
                    {% if category.grouper %}{{ category.grouper.name }}{% else %}Divers{% endif %}
                </td>
            </tr>

            {% for entry in category.list %}
            {% with item=entry.item previous=entry.previous_result prev_date=entry.previous_date %}
            <tr>
                <td style="padding-left: 10px;">
                    <strong>{{ item.lab_test.name }}</strong>
                    {% if item.lab_test.methodology %}
                    <div style="font-size: 7pt; color: #888;">{{ item.lab_test.methodology }}</div>
                    {% endif %}
                </td>
                <td class="result-value {% if item.is_abnormal %}abnormal{% endif %}">
                    {{ item.result_value|default:"-" }}
                </td>
                <td class="unit">{{ item.result_unit|default:item.lab_test.unit_of_measurement|default:"" }}</td>
                <td class="range">
                    {{ item.reference_range|default:"-" }}
                </td>
                <td class="range">
                    {% if previous %}
                    <strong>{{ previous }}</strong> <span style="font-size: 6pt;">({{ prev_date }})</span>
                    {% else %}
                    <span style="color: #ccc;">-</span>
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    {% if item.is_abnormal %}
                    <span class="flag-marker">!</span>
                    {% endif %}
                </td>
            </tr>
            {% if item.technician_notes or item.interpretation %}
            <tr>
                <td colspan="6" style="padding-left: 10px; padding-bottom: 10px;">
                    <div style="background-color: #f9f9f9; padding: 5px; font-size: 8pt; border-left: 2px solid #ccc;">
                        {% if item.interpretation %}
                        <strong>Interprétation:</strong> {{ item.interpretation }}<br>
                        {% endif %}
                        {% if item.technician_notes %}
                        <em>Note: {{ item.technician_notes }}</em>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endif %}
            {% endwith %}
            {% endfor %}
            {% endfor %}
        </tbody>
    </table>

    <!-- Biologist Diagnosis -->
    {% if order.biologist_diagnosis %}
    <div
        style="margin-top: 20px; background-color: #f0fdf4; border: 1px solid #22c55e; padding: 10px; border-radius: 4px; color: #166534;">
        <div class="info-label" style="margin-bottom: 5px; color: #15803d; font-weight: bold;">Diagnostic du Biologiste
        </div>
        <div style="font-size: 10pt; font-weight: 500;">
            {{ order.biologist_diagnosis|linebreaksbr }}
        </div>
    </div>
    {% endif %}

    <!-- Footer signatures -->
    <div class="footer-section">
        <div class="signature-grid">
            <div class="signature-box">
                <div class="info-label">Technicien de Laboratoire</div>
                <div class="signature-line">
                    {% if order.results_entered_by %}{{ order.results_entered_by.get_full_name }}{% endif %}
                </div>
            </div>
            <div class="signature-box">
                <div class="info-label">Validé par</div>
                <div class="signature-line">
                    {% if order.results_verified_by %}<strong>{{ order.results_verified_by.get_full_name }}</strong>{%
                    endif %}
                </div>
            </div>
            <div class="signature-box">
                <!-- Empty for layout balance or Stamp -->
                <div class="info-label">Cachet</div>
                <div class="signature-line" style="border: none; border: 1px dashed #ccc; height: 50px;"></div>
            </div>
        </div>
    </div>

    <div style="text-align: center; margin-top: 30px; font-size: 7pt; color: #999;">
        Ce document est certifié et généré électroniquement par {{ organization.name }} - ProcureGenius System
    </div>
</body>

</html>