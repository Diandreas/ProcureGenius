{% extends 'pdf_base.html' %}
{% load i18n %}

{% block title %}Rapport Consultation - {{ patient.name }}{% endblock %}

{% block extra_css %}
<style>
    .report-title {
        text-align: center;
        font-size: 20pt;
        font-weight: bold;
        margin: 20px 0 30px 0;
        text-transform: uppercase;
        color: #2c3e50;
    }

    .section {
        margin-bottom: 25px;
    }

    .section-title {
        font-size: 12pt;
        font-weight: bold;
        color: {{ organization.brand_color|default:"#2563eb" }};
        border-bottom: 1px solid #eee;
        margin-bottom: 10px;
        padding-bottom: 3px;
        text-transform: uppercase;
    }

    .grid-row {
        display: table;
        width: 100%;
        margin-bottom: 10px;
    }

    .grid-col {
        display: table-cell;
        width: 50%;
        vertical-align: top;
    }

    .label {
        font-weight: bold;
        color: #666;
        width: 120px;
        display: inline-block;
    }

    .vitals-grid {
        display: table;
        width: 100%;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
    }

    .vitals-grid-row {
        display: table-row;
    }

    .vital-item {
        display: table-cell;
        width: 25%;
        text-align: center;
        padding: 5px;
    }

    .vital-label {
        font-size: 9pt;
        color: #666;
        display: block;
    }

    .vital-value {
        font-size: 11pt;
        font-weight: bold;
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div style="text-align: right; font-size: 9pt; color: #666; margin-bottom: 10px;">
    Consultation N°: {{ consultation.consultation_number }}<br>
    Date: {{ consultation.consultation_date|date:"d/m/Y H:i" }}
</div>

<div class="report-title">Compte Rendu de Consultation</div>

<div class="section">
    <div class="section-title">Patient & Médecin</div>
    <div class="grid-row">
        <div class="grid-col">
            <div><span class="label">Patient:</span> <b>{{ patient.name }}</b></div>
            <div><span class="label">ID Patient:</span> {{ patient.patient_number }}</div>
            <div><span class="label">Âge/Sexe:</span> {{ patient.get_age }} ans / {{ patient.gender }}</div>
        </div>
        <div class="grid-col">
            <div><span class="label">Médecin:</span> <b>Dr. {{ consultation.doctor.get_full_name }}</b></div>
            <div><span class="label">Spécialité:</span> Médecine Générale</div>
        </div>
    </div>
</div>

<div class="section">
    <div class="section-title">Signes Vitaux</div>
    <div class="vitals-grid">
        <div class="vitals-grid-row">
            <div class="vital-item">
                <span class="vital-label">Tension Artérielle</span>
                <span class="vital-value">{{ consultation.blood_pressure|default:"-" }} mmHg</span>
            </div>
            <div class="vital-item">
                <span class="vital-label">Température</span>
                <span class="vital-value">{{ consultation.temperature|default:"-" }} °C</span>
            </div>
            <div class="vital-item">
                <span class="vital-label">FC</span>
                <span class="vital-value">{{ consultation.heart_rate|default:"-" }} pls/min</span>
            </div>
            <div class="vital-item">
                <span class="vital-label">SPO2</span>
                <span class="vital-value">{{ consultation.oxygen_saturation|default:"-" }} %</span>
            </div>
        </div>
        <div class="vitals-grid-row">
            <div class="vital-item">
                <span class="vital-label">FR</span>
                <span class="vital-value">{{ consultation.respiratory_rate|default:"-" }} cycle/min</span>
            </div>
            <div class="vital-item">
                <span class="vital-label">Glycémie</span>
                <span class="vital-value">{{ consultation.blood_glucose|default:"-" }} g/L</span>
            </div>
            <div class="vital-item">
                <span class="vital-label">Poids</span>
                <span class="vital-value">{{ consultation.weight|default:"-" }} kg</span>
            </div>
            <div class="vital-item">
                <span class="vital-label">Taille / IMC</span>
                <span class="vital-value">{{ consultation.height|default:"-" }} cm / {{ consultation.bmi|default:"-" }}</span>
            </div>
        </div>
    </div>
</div>

<div class="section">
    <div class="section-title">Motif & Histoire</div>
    <div style="margin-bottom: 10px;">
        <span class="label">Motif:</span> {{ consultation.chief_complaint }}
    </div>
    <div>
        <span class="label" style="vertical-align: top;">Histoire:</span>
        <div style="display: inline-block; width: 80%; vertical-align: top;">
            {{ consultation.history_of_present_illness|default:"Non spécifié" }}
        </div>
    </div>
</div>

<div class="section">
    <div class="section-title">Examen Clinique</div>
    <p>{{ consultation.physical_examination|linebreaks|default:"RAS" }}</p>
</div>

<div class="section">
    <div class="section-title">Diagnostic</div>
    <p style="font-weight: bold;">{{ consultation.diagnosis|default:"En cours d'investigation" }}</p>
</div>

<div class="section">
    <div class="section-title">Plan de Traitement</div>
    <p>{{ consultation.treatment_plan|linebreaks|default:"-" }}</p>
</div>

{% if prescriptions %}
<div class="section">
    <div class="section-title">Ordonnance</div>
    {% for pres in prescriptions %}
    <p style="font-size: 9pt; color: #666;">{{ pres.prescription_number }}</p>
    <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px;">
        <thead>
            <tr style="background: #f8f9fa;">
                <th style="text-align: left; padding: 4px 8px; border-bottom: 1px solid #ddd; font-size: 9pt;">Médicament</th>
                <th style="text-align: left; padding: 4px 8px; border-bottom: 1px solid #ddd; font-size: 9pt;">Posologie</th>
                <th style="text-align: left; padding: 4px 8px; border-bottom: 1px solid #ddd; font-size: 9pt;">Fréquence</th>
                <th style="text-align: left; padding: 4px 8px; border-bottom: 1px solid #ddd; font-size: 9pt;">Durée</th>
            </tr>
        </thead>
        <tbody>
            {% for item in pres.items.all %}
            <tr>
                <td style="padding: 4px 8px; border-bottom: 1px solid #eee; font-size: 9pt;"><b>{{ item.medication_name }}</b></td>
                <td style="padding: 4px 8px; border-bottom: 1px solid #eee; font-size: 9pt;">{{ item.dosage|default:"-" }}</td>
                <td style="padding: 4px 8px; border-bottom: 1px solid #eee; font-size: 9pt;">{{ item.frequency|default:"-" }}</td>
                <td style="padding: 4px 8px; border-bottom: 1px solid #eee; font-size: 9pt;">{{ item.duration|default:"-" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endfor %}
</div>
{% endif %}

{% if lab_orders %}
<div class="section">
    <div class="section-title">Examens de Laboratoire Prescrits</div>
    {% for order in lab_orders %}
    <p style="font-size: 9pt; color: #666;">{{ order.order_number }}</p>
    <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px;">
        <thead>
            <tr style="background: #f0fdf4;">
                <th style="text-align: left; padding: 4px 8px; border-bottom: 1px solid #ddd; font-size: 9pt;">#</th>
                <th style="text-align: left; padding: 4px 8px; border-bottom: 1px solid #ddd; font-size: 9pt;">Examen</th>
                <th style="text-align: left; padding: 4px 8px; border-bottom: 1px solid #ddd; font-size: 9pt;">Code</th>
            </tr>
        </thead>
        <tbody>
            {% for item in order.items.all %}
            <tr>
                <td style="padding: 4px 8px; border-bottom: 1px solid #eee; font-size: 9pt;">{{ forloop.counter }}</td>
                <td style="padding: 4px 8px; border-bottom: 1px solid #eee; font-size: 9pt;"><b>{{ item.lab_test.name }}</b></td>
                <td style="padding: 4px 8px; border-bottom: 1px solid #eee; font-size: 9pt;">{{ item.lab_test.test_code }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endfor %}
</div>
{% endif %}

<div style="margin-top: 50px; text-align: right;">
    <p>Signature:</p>
    <div style="height: 60px;"></div>
    <p><b>Dr. {{ consultation.doctor.get_full_name }}</b></p>
</div>

<div style="margin-top: 20px; font-size: 8pt; color: #999; text-align: center; border-top: 1px solid #eee; padding-top: 5px;">
    Imprimé par: {{ printed_by.get_full_name|default:printed_by.username }} | {% now "d/m/Y à H:i" %}
</div>
{% endblock %}