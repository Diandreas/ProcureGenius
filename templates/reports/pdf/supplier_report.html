{% extends "reports/pdf/base_report.html" %}

{% block title %}Rapport Fournisseur - {{ supplier.name }}{% endblock %}

{% block report_title %}Rapport Fournisseur{% endblock %}
{% block report_subtitle %}{{ supplier.name }} • Généré le {{ generated_at|date:"d/m/Y à H:i" }}{% endblock %}

{% block content %}
<!-- Informations du fournisseur -->
<div class="info-grid">
    <div class="info-box">
        <h3>Informations Générales</h3>
        <div class="content">
            <strong>{{ supplier.name }}</strong>
            {% if supplier.contact_person %}<div><span class="label">Contact:</span> <span class="value">{{ supplier.contact_person }}</span></div>{% endif %}
            {% if supplier.email %}<div><span class="label">Email:</span> <span class="value">{{ supplier.email }}</span></div>{% endif %}
            {% if supplier.phone %}<div><span class="label">Téléphone:</span> <span class="value">{{ supplier.phone }}</span></div>{% endif %}
            {% if supplier.city %}<div><span class="label">Ville:</span> <span class="value">{{ supplier.city }}, {{ supplier.province|default:"" }}</span></div>{% endif %}
        </div>
    </div>

    <div class="info-box">
        <h3>Statut & Évaluation</h3>
        <div class="content">
            <div><span class="label">Statut:</span> 
                {% if supplier.status == 'active' %}
                    <span class="badge success">Actif</span>
                {% else %}
                    <span class="badge warning">Inactif</span>
                {% endif %}
            </div>
            {% if supplier.rating %}<div><span class="label">Note:</span> <span class="value">{{ supplier.rating }}/5 ⭐</span></div>{% endif %}
            {% if supplier.is_local %}<div><span class="badge info">Fournisseur Local</span></div>{% endif %}
        </div>
    </div>
</div>

<!-- Statistiques Financières -->
<div class="stats-grid">
    <div class="stat-card primary">
        <div class="label">Total Dépensé</div>
        <div class="value">{{ total_spent|floatformat:2 }} $</div>
        <div class="subvalue">{{ organization.currency|default:"CAD" }}</div>
    </div>
    
    <div class="stat-card success">
        <div class="label">Nombre de Commandes</div>
        <div class="value">{{ total_orders }}</div>
        <div class="subvalue">Bons de commande</div>
    </div>
    
    <div class="stat-card warning">
        <div class="label">Valeur Moyenne</div>
        <div class="value">{{ avg_order_value|floatformat:2 }} $</div>
        <div class="subvalue">Par commande</div>
    </div>
</div>

<!-- Commandes par Statut -->
{% if po_by_status %}
<div class="section">
    <h2 class="section-title">Répartition des Commandes par Statut</h2>
    <table>
        <thead>
            <tr>
                <th>Statut</th>
                <th class="text-center">Nombre</th>
                <th class="text-right">Montant Total</th>
            </tr>
        </thead>
        <tbody>
            {% for stat in po_by_status %}
            <tr>
                <td>
                    {% if stat.status == 'draft' %}<span class="badge info">Brouillon</span>
                    {% elif stat.status == 'sent' %}<span class="badge warning">Envoyé</span>
                    {% elif stat.status == 'approved' %}<span class="badge success">Approuvé</span>
                    {% elif stat.status == 'received' %}<span class="badge success">Reçu</span>
                    {% elif stat.status == 'cancelled' %}<span class="badge danger">Annulé</span>
                    {% else %}{{ stat.status }}{% endif %}
                </td>
                <td class="text-center">{{ stat.count }}</td>
                <td class="text-right">{{ stat.total|default:0|floatformat:2 }} {{ organization.currency|default:"CAD" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Top Produits/Services -->
{% if top_products %}
<div class="section">
    <h2 class="section-title">Produits/Services les Plus Achetés</h2>
    <table>
        <thead>
            <tr>
                <th>Référence</th>
                <th>Description</th>
                <th class="text-center">Quantité Totale</th>
                <th class="text-right">Valeur Totale</th>
            </tr>
        </thead>
        <tbody>
            {% for product in top_products %}
            <tr>
                <td>{{ product.product_reference|default:"-" }}</td>
                <td>{{ product.description|truncatewords:10 }}</td>
                <td class="text-center">{{ product.total_qty|default:0 }}</td>
                <td class="text-right">{{ product.total_value|default:0|floatformat:2 }} {{ organization.currency|default:"CAD" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Activité Récente -->
{% if recent_activity %}
<div class="section">
    <h2 class="section-title">Activité Récente (6 derniers mois)</h2>
    <table>
        <thead>
            <tr>
                <th>N° Bon de Commande</th>
                <th>Date</th>
                <th>Statut</th>
                <th class="text-right">Montant</th>
            </tr>
        </thead>
        <tbody>
            {% for po in recent_activity %}
            <tr>
                <td><strong>{{ po.po_number }}</strong></td>
                <td>{{ po.created_at|date:"d/m/Y" }}</td>
                <td>
                    {% if po.status == 'draft' %}<span class="badge info">Brouillon</span>
                    {% elif po.status == 'sent' %}<span class="badge warning">Envoyé</span>
                    {% elif po.status == 'approved' %}<span class="badge success">Approuvé</span>
                    {% elif po.status == 'received' %}<span class="badge success">Reçu</span>
                    {% elif po.status == 'cancelled' %}<span class="badge danger">Annulé</span>
                    {% else %}{{ po.status }}{% endif %}
                </td>
                <td class="text-right">{{ po.total_amount|floatformat:2 }} {{ organization.currency|default:"CAD" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Notes -->
{% if supplier.notes %}
<div class="highlight-box">
    <strong>Notes:</strong>
    {{ supplier.notes }}
</div>
{% endif %}

{% endblock %}

