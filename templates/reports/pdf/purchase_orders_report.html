{% extends "reports/pdf/base_report.html" %}
{% load invoice_filters %}

{% block title %}Rapport des Bons de Commande{% endblock %}

{% block report_title %}üì¶ Rapport des Bons de Commande{% endblock %}
{% block report_subtitle %}
{% if date_start or date_end %}
P√©riode: {% if date_start %}{{ date_start|date:"d/m/Y" }}{% else %}D√©but{% endif %} - {% if date_end %}{{
date_end|date:"d/m/Y" }}{% else %}Aujourd'hui{% endif %}
{% endif %}
‚Ä¢ {{ total_count }} bon(s) ‚Ä¢ G√©n√©r√© le {{ generated_at|date:"d/m/Y √† H:i" }}
{% endblock %}

{% block content %}

<div class="stats-grid" style="margin-bottom: 15px;">
    <div class="stat-card primary">
        <div class="label">Bons √âmis</div>
        <div class="value">{{ total_count }}</div>
        <div class="subvalue">{% if evolution_percentage > 0 %}+{% endif %}{{evolution_percentage|floatformat:1}}%</div>
    </div>
    <div class="stat-card success">
        <div class="label">Montant Total</div>
        <div class="value">{{ total_amount|floatformat:2 }}</div>
        <div class="subvalue">{{ organization.currency|default:"CAD" }}</div>
    </div>
    <div class="stat-card warning">
        <div class="label">Co√ªt Moyen</div>
        <div class="value">{{ avg_amount|floatformat:2 }}</div>
        <div class="subvalue">Par bon</div>
    </div>
    <div class="stat-card {% if approval_rate >= 90 %}success{% else %}warning{% endif %}">
        <div class="label">Taux R√©ception</div>
        <div class="value">{{ reception_rate|floatformat:1 }}%</div>
        <div class="subvalue">{{ received_count }} re√ßus</div>
    </div>
</div>

<div class="section" style="margin-bottom: 15px;">
    <h2 class="section-title">‚ö° Performance</h2>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 11px;">
        <div style="background: #e8f5e9; padding: 8px; border-radius: 4px;">
            <div style="font-weight: bold; color: #2e7d32;">Taux Approbation</div>
            <div style="font-size: 14px; font-weight: bold;">{{ approval_rate|floatformat:1 }}%</div>
        </div>
        <div style="background: #e3f2fd; padding: 8px; border-radius: 4px;">
            <div style="font-weight: bold; color: #1565c0;">Taux R√©ception</div>
            <div style="font-size: 14px; font-weight: bold;">{{ reception_rate|floatformat:1 }}%</div>
        </div>
        <div style="background: #fff3e0; padding: 8px; border-radius: 4px;">
            <div style="font-weight: bold; color: #ef6c00;">Taux Annulation</div>
            <div style="font-size: 14px; font-weight: bold;">{{ cancellation_rate|floatformat:1 }}%</div>
        </div>
    </div>
</div>

{% if top_suppliers %}
<div class="section" style="margin-bottom: 15px;">
    <h2 class="section-title">üè¢ Top 5 Fournisseurs</h2>
    <table style="font-size: 10px;">
        <thead>
            <tr>
                <th style="width: 50%;">Fournisseur</th>
                <th class="text-center" style="width: 15%;">Bons</th>
                <th class="text-right" style="width: 20%;">Volume</th>
                <th class="text-right" style="width: 15%;">%</th>
            </tr>
        </thead>
        <tbody>
            {% for supplier in top_suppliers|slice:":5" %}
            <tr>
                <td><strong>{{ supplier.name|truncatewords:5 }}</strong></td>
                <td class="text-center">{{ supplier.count }}</td>
                <td class="text-right">{{ supplier.total|floatformat:2 }} {{ organization.currency|default:"CAD" }}</td>
                <td class="text-right">{{ supplier.percentage|floatformat:1 }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div
        style="background: {% if concentration_risk %}#ffebee{% else %}#f5f5f5{% endif %}; padding: 6px; margin-top: 8px; font-size: 10px; border-radius: 3px;">
        <strong>{% if concentration_risk %}‚ö†Ô∏è Concentration:{% else %}Concentration:{% endif %}</strong> Top 5 = {{
        top5_percentage|floatformat:1 }}%
    </div>
</div>
{% endif %}

{% if overdue_count > 0 or pending_approval_count > 0 %}
<div class="section" style="margin-bottom: 15px;">
    <h2 class="section-title">‚ö†Ô∏è Alertes</h2>
    <div style="font-size: 10px;">
        {% if overdue_count > 0 %}<div
            style="background: #ffebee; padding: 8px; margin-bottom: 5px; border-left: 3px solid #c62828; border-radius: 3px;">
            <strong style="color: #c62828;">‚ö†Ô∏è {{ overdue_count }} bon(s) en retard</strong></div>{% endif %}
        {% if pending_approval_count > 0 %}<div
            style="background: #fff3e0; padding: 8px; border-left: 3px solid #ef6c00; border-radius: 3px;"><strong
                style="color: #ef6c00;">üìã {{ pending_approval_count }} en attente d'approbation</strong></div>{% endif
        %}
    </div>
</div>
{% endif %}

<!-- R√âPARTITION PAR STATUT (GARD√â) -->
{% if by_status %}
<div class="section" style="margin-bottom: 15px;">
    <h2 class="section-title">üìä R√©partition par Statut</h2>
    <table style="font-size: 10px;">
        <thead>
            <tr>
                <th>Statut</th>
                <th class="text-center">Nombre</th>
                <th class="text-right">Montant</th>
                <th class="text-right">%</th>
            </tr>
        </thead>
        <tbody>
            {% for stat in by_status %}
            <tr>
                <td>
                    {% if stat.status == 'draft' %}<span class="badge info">Brouillon</span>
                    {% elif stat.status == 'sent' %}<span class="badge warning">Envoy√©</span>
                    {% elif stat.status == 'approved' %}<span class="badge success">Approuv√©</span>
                    {% elif stat.status == 'received' %}<span class="badge success">Re√ßu</span>
                    {% elif stat.status == 'cancelled' %}<span class="badge danger">Annul√©</span>
                    {% else %}{{ stat.status }}{% endif %}
                </td>
                <td class="text-center">{{ stat.count }}</td>
                <td class="text-right">{{ stat.total|floatformat:2 }} {{ organization.currency|default:"CAD" }}</td>
                <td class="text-right">{{ stat.percentage|floatformat:1 }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- LISTE DES BONS DE COMMANDE (ESSENTIEL - GARD√â) -->
<div class="section" style="margin-bottom: 15px;">
    <h2 class="section-title">üìã Liste des Bons de Commande</h2>
    <table style="font-size: 10px;">
        <thead>
            <tr>
                <th>N¬∞ Bon</th>
                <th>Fournisseur</th>
                <th>Date cr√©ation</th>
                <th>Statut</th>
                <th class="text-right">Montant</th>
            </tr>
        </thead>
        <tbody>
            {% for po in purchase_orders %}
            <tr>
                <td><strong>{{ po.po_number|default:"-" }}</strong></td>
                <td>{{ po.supplier.name|truncatewords:4|default:"-" }}</td>
                <td>{{ po.created_at|date:"d/m/Y" }}</td>
                <td>
                    {% if po.status == 'draft' %}<span class="badge info">Brouillon</span>
                    {% elif po.status == 'sent' %}<span class="badge warning">Envoy√©</span>
                    {% elif po.status == 'approved' %}<span class="badge success">Approuv√©</span>
                    {% elif po.status == 'received' %}<span class="badge success">Re√ßu</span>
                    {% elif po.status == 'cancelled' %}<span class="badge danger">Annul√©</span>
                    {% else %}{{ po.status }}{% endif %}
                </td>
                <td class="text-right">{{ po.total_amount|floatformat:2 }} {{ organization.currency|default:"CAD" }}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" style="text-align: center; color: #999;">Aucun bon de commande</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="highlight-box" style="font-size: 10px;">
    <strong style="font-size: 11px;">üìù R√©sum√©</strong>
    <div style="margin-top: 6px;">
        <strong>{{ total_count }} bons</strong> pour <strong>{{ total_amount|floatformat:2 }} {{
            organization.currency|default:"CAD" }}</strong>.
        Performance: {{ reception_rate|floatformat:1 }}% r√©ception.
        {% if concentration_risk %}‚ö†Ô∏è Concentration risqu√©e.{% endif %}
    </div>
</div>

{% endblock %}