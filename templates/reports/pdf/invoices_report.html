{% extends "reports/pdf/base_report.html" %}
{% load invoice_filters %}

{% block title %}Rapport des Factures{% endblock %}

{% block report_title %}üìã Rapport des Factures{% endblock %}
{% block report_subtitle %}
{% if date_start or date_end %}
P√©riode: {% if date_start %}{{ date_start|date:"d/m/Y" }}{% else %}D√©but{% endif %} - {% if date_end %}{{
date_end|date:"d/m/Y" }}{% else %}Aujourd'hui{% endif %}
{% endif %}
‚Ä¢ {{ total_count }} facture(s) ‚Ä¢ G√©n√©r√© le {{ generated_at|date:"d/m/Y √† H:i" }}
{% endblock %}

{% block content %}

<!-- === SECTION 1: VUE D'ENSEMBLE (NOUVELLES STATS) === -->
<div class="stats-grid" style="margin-bottom: 15px;">
    <div class="stat-card primary">
        <div class="label">Factures</div>
        <div class="value">{{ total_count }}</div>
        <div class="subvalue">
            {% if evolution_percentage > 0 %}+{% endif %}{{ evolution_percentage|floatformat:1 }}% vs mois dernier
        </div>
    </div>

    <div class="stat-card success">
        <div class="label">CA Total</div>
        <div class="value">{{ total_amount|floatformat:2 }}</div>
        <div class="subvalue">{{ organization.currency|default:"CAD" }}</div>
    </div>

    <div class="stat-card warning">
        <div class="label">Panier Moyen</div>
        <div class="value">{{ avg_amount|floatformat:2 }}</div>
        <div class="subvalue">{{ organization.currency|default:"CAD" }}</div>
    </div>

    <div class="stat-card {% if payment_rate >= 70 %}success{% else %}danger{% endif %}">
        <div class="label">Taux Paiement</div>
        <div class="value">{{ payment_rate|floatformat:1 }}%</div>
        <div class="subvalue">{{ paid_amount|floatformat:2 }} {{ organization.currency|default:"CAD" }}</div>
    </div>
</div>

<!-- === SECTION 2: R√âPARTITION FINANCI√àRE (NOUVELLE) === -->
<div class="section" style="margin-bottom: 15px;">
    <h2 class="section-title">üí∞ R√©partition Financi√®re</h2>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 11px;">
        <div style="background: #e8f5e9; padding: 8px; border-radius: 4px;">
            <div style="font-weight: bold; color: #2e7d32;">‚úì Pay√©</div>
            <div style="font-size: 14px; font-weight: bold;">{{ paid_amount|floatformat:2 }} {{
                organization.currency|default:"CAD" }}</div>
            <div style="color: #666;">{{ payment_rate|floatformat:1 }}% du total</div>
        </div>
        <div style="background: #fff3e0; padding: 8px; border-radius: 4px;">
            <div style="font-weight: bold; color: #ef6c00;">‚è≥ En attente</div>
            <div style="font-size: 14px; font-weight: bold;">{{ pending_amount|floatformat:2 }} {{
                organization.currency|default:"CAD" }}</div>
            <div style="color: #666;">{{ by_status|length }} facture(s)</div>
        </div>
        <div style="background: #ffebee; padding: 8px; border-radius: 4px;">
            <div style="font-weight: bold; color: #c62828;">‚ö†Ô∏è En retard</div>
            <div style="font-size: 14px; font-weight: bold;">{{ overdue_amount|floatformat:2 }} {{
                organization.currency|default:"CAD" }}</div>
            <div style="color: #666;">{{ overdue_rate|floatformat:1 }}% du total</div>
        </div>
    </div>
</div>

<!-- === SECTION 3: TOP 5 CLIENTS (NOUVELLE) === -->
{% if top_clients %}
<div class="section" style="margin-bottom: 15px;">
    <h2 class="section-title">üëë Top 5 Clients (CA)</h2>
    <table style="font-size: 10px;">
        <thead>
            <tr>
                <th style="width: 50%;">Client</th>
                <th class="text-center" style="width: 15%;">Factures</th>
                <th class="text-right" style="width: 20%;">CA</th>
                <th class="text-right" style="width: 15%;">% Total</th>
            </tr>
        </thead>
        <tbody>
            {% for client in top_clients|slice:":5" %}
            <tr>
                <td><strong>{{ client.name|truncatewords:5 }}</strong></td>
                <td class="text-center">{{ client.count }}</td>
                <td class="text-right">{{ client.total|floatformat:2 }} {{ organization.currency|default:"CAD" }}</td>
                <td class="text-right">{{ client.percentage|floatformat:1 }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div style="background: #f5f5f5; padding: 6px; margin-top: 8px; font-size: 10px; border-radius: 3px;">
        <strong>Analyse Pareto:</strong> Les {{ pareto_count }} meilleurs clients (20%) repr√©sentent
        <strong>{{ pareto_percentage|floatformat:1 }}%</strong> du CA total
    </div>
</div>
{% endif %}

<!-- === SECTION 4: √âVOLUTION MENSUELLE (NOUVELLE) === -->
{% if monthly_evolution %}
<div class="section" style="margin-bottom: 15px;">
    <h2 class="section-title">üìà √âvolution (6 derniers mois)</h2>
    <table style="font-size: 10px;">
        <thead>
            <tr>
                <th>Mois</th>
                <th class="text-center">Factures</th>
                <th class="text-right">CA</th>
            </tr>
        </thead>
        <tbody>
            {% for month in monthly_evolution %}
            <tr>
                <td><strong>{{ month.month }}</strong></td>
                <td class="text-center">{{ month.count }}</td>
                <td class="text-right">{{ month.total|floatformat:2 }} {{ organization.currency|default:"CAD" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- === SECTION 5: ALERTES (NOUVELLE) === -->
{% if overdue_count > 0 or due_soon_count > 0 or due_30_days > 0 %}
<div class="section" style="margin-bottom: 15px;">
    <h2 class="section-title">‚ö†Ô∏è Alertes & Actions Requises</h2>
    <div style="font-size: 10px;">
        {% if overdue_count > 0 %}
        <div
            style="background: #ffebee; padding: 8px; margin-bottom: 5px; border-left: 3px solid #c62828; border-radius: 3px;">
            <strong style="color: #c62828;">‚ö†Ô∏è {{ overdue_count }} facture(s) en retard</strong> ({{
            overdue_amount|floatformat:2 }} {{ organization.currency|default:"CAD" }})
            <div style="color: #666; margin-top: 3px;">‚Üí Action imm√©diate requise: relances clients</div>
        </div>
        {% endif %}

        {% if due_soon_count > 0 %}
        <div
            style="background: #fff3e0; padding: 8px; margin-bottom: 5px; border-left: 3px solid #ef6c00; border-radius: 3px;">
            <strong style="color: #ef6c00;">üìÖ {{ due_soon_count }} facture(s) √©ch√©ance < 7 jours</strong>
                    <div style="color: #666; margin-top: 3px;">‚Üí Pr√©parer les relances pr√©ventives</div>
        </div>
        {% endif %}

        {% if due_30_days > 0 %}
        <div style="background: #ffebee; padding: 8px; border-left: 3px solid #c62828; border-radius: 3px;">
            <strong style="color: #c62828;">üî¥ {{ due_30_days }} facture(s) > 30 jours sans paiement</strong>
            <div style="color: #666; margin-top: 3px;">‚Üí Envisager proc√©dures de recouvrement</div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- === SECTION 6: R√âPARTITION PAR STATUT (EXISTANTE - GARD√âE) === -->
{% if by_status %}
<div class="section" style="margin-bottom: 15px;">
    <h2 class="section-title">üìä R√©partition par Statut</h2>
    <table style="font-size: 10px;">
        <thead>
            <tr>
                <th>Statut</th>
                <th class="text-center">Nombre</th>
                <th class="text-right">Montant Total</th>
                <th class="text-right">% du Total</th>
            </tr>
        </thead>
        <tbody>
            {% for stat in by_status %}
            <tr>
                <td>
                    {% if stat.status == 'draft' %}<span class="badge info">Brouillon</span>
                    {% elif stat.status == 'sent' %}<span class="badge warning">Envoy√©e</span>
                    {% elif stat.status == 'paid' %}<span class="badge success">Pay√©e</span>
                    {% elif stat.status == 'overdue' %}<span class="badge danger">En retard</span>
                    {% elif stat.status == 'cancelled' %}<span class="badge danger">Annul√©e</span>
                    {% else %}{{ stat.status }}{% endif %}
                </td>
                <td class="text-center">{{ stat.count }}</td>
                <td class="text-right">{{ stat.total|default:0|floatformat:2 }} {{ organization.currency|default:"CAD"
                    }}</td>
                <td class="text-right">{{ stat.percentage|floatformat:1 }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- === SECTION 7: LISTE DES FACTURES (EXISTANTE - GARD√âE + ESSENTIELLE) === -->
<div class="section" style="margin-bottom: 15px;">
    <h2 class="section-title">üìã Liste des Factures</h2>
    <table style="font-size: 10px;">
        <thead>
            <tr>
                <th>N¬∞ Facture</th>
                <th>Client</th>
                <th>Date d'√©mission</th>
                <th>Date d'√©ch√©ance</th>
                <th>Statut</th>
                <th class="text-right">Montant</th>
            </tr>
        </thead>
        <tbody>
            {% for invoice in invoices %}
            <tr>
                <td><strong>{{ invoice.invoice_number|default:"-" }}</strong></td>
                <td>
                    {% if invoice.client %}
                    {{ invoice.client.name|truncatewords:4|default:"-" }}
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>
                    {% if invoice.created_at %}
                    {{ invoice.created_at|date:"d/m/Y" }}
                    {% elif invoice.issue_date %}
                    {{ invoice.issue_date|date:"d/m/Y" }}
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>
                    {% if invoice.due_date %}
                    {{ invoice.due_date|date:"d/m/Y" }}
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>
                    {% if invoice.status == 'draft' %}<span class="badge info">Brouillon</span>
                    {% elif invoice.status == 'sent' %}<span class="badge warning">Envoy√©e</span>
                    {% elif invoice.status == 'paid' %}<span class="badge success">Pay√©e</span>
                    {% elif invoice.status == 'overdue' %}<span class="badge danger">En retard</span>
                    {% elif invoice.status == 'cancelled' %}<span class="badge danger">Annul√©e</span>
                    {% else %}{{ invoice.status|default:"-" }}{% endif %}
                </td>
                <td class="text-right">{{ invoice.total_amount|default:0|floatformat:2 }} {{
                    organization.currency|default:"CAD" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" style="text-align: center; color: #999;">Aucune facture dans cette s√©lection</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- === SECTION 8: R√âSUM√â EX√âCUTIF === -->
<div class="highlight-box" style="font-size: 10px; page-break-inside: avoid;">
    <strong style="font-size: 11px;">üìù R√©sum√© Ex√©cutif</strong>
    <div style="margin-top: 6px; line-height: 1.5;">
        Ce rapport couvre <strong>{{ total_count }} facture(s)</strong> pour un CA total de
        <strong>{{ total_amount|floatformat:2 }} {{ organization.currency|default:"CAD" }}</strong>.
        <br>
        <strong>Performance:</strong> Taux de paiement de {{ payment_rate|floatformat:1 }}%
        ({{ paid_amount|floatformat:2 }} {{ organization.currency|default:"CAD" }} pay√©s).
        {% if overdue_amount > 0 %}
        ‚ö†Ô∏è <strong>{{ overdue_amount|floatformat:2 }} {{ organization.currency|default:"CAD" }}</strong> en retard √†
        recouvrer.
        {% endif %}
        <br>
        <strong>Concentration:</strong> Les {{ pareto_count }} meilleurs clients (20%) repr√©sentent {{
        pareto_percentage|floatformat:1 }}% du CA.
        {% if date_start or date_end %}
        <br>P√©riode couverte:
        {% if date_start %}du {{ date_start|date:"d/m/Y" }}{% endif %}
        {% if date_end %}au {{ date_end|date:"d/m/Y" }}{% endif %}.
        {% endif %}
    </div>
</div>

{% endblock %}