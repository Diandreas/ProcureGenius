{% extends "reports/pdf/base_report.html" %}

{% block title %}Rapport des Fournisseurs{% endblock %}

{% block report_title %}üè¢ Rapport des Fournisseurs{% endblock %}
{% block report_subtitle %}
{% if date_start or date_end %}
P√©riode: {% if date_start %}{{ date_start|date:"d/m/Y" }}{% else %}D√©but{% endif %} - {% if date_end %}{{
date_end|date:"d/m/Y" }}{% else %}Aujourd'hui{% endif %}
{% endif %}
‚Ä¢ {{ total_count }} fournisseur(s) ‚Ä¢ G√©n√©r√© le {{ generated_at|date:"d/m/Y √† H:i" }}
{% endblock %}

{% block content %}

<div class="stats-grid" style="margin-bottom: 15px;">
    <div class="stat-card primary">
        <div class="label">Total Fournisseurs</div>
        <div class="value">{{ total_count }}</div>
        <div class="subvalue">{{ active_count }} actifs ({{ active_percentage|floatformat:0 }}%)</div>
    </div>
    <div class="stat-card success">
        <div class="label">Volume Achats</div>
        <div class="value">{{ total_volume|floatformat:2 }}</div>
        <div class="subvalue">{{ organization.currency|default:"CAD" }}</div>
    </div>
    <div class="stat-card warning">
        <div class="label">Note Moyenne</div>
        <div class="value">{{ avg_rating|floatformat:1 }}</div>
        <div class="subvalue">/ 5.0 ‚≠ê</div>
    </div>
    <div class="stat-card {% if local_percentage >= 40 %}success{% else %}info{% endif %}">
        <div class="label">Locaux</div>
        <div class="value">{{ local_count }}</div>
        <div class="subvalue">{{ local_percentage|floatformat:0 }}% du total</div>
    </div>
</div>

<div class="section" style="margin-bottom: 15px;">
    <h2 class="section-title">‚≠ê Performance par Note</h2>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 11px;">
        <div style="background: #e8f5e9; padding: 8px; border-radius: 4px;">
            <div style="font-weight: bold; color: #2e7d32;">‚≠ê Excellent (4.5+)</div>
            <div style="font-size: 14px; font-weight: bold;">{{ excellent_count }} fournisseurs</div>
            <div style="color: #666;">{{ excellent_percentage|floatformat:0 }}%</div>
        </div>
        <div style="background: #e3f2fd; padding: 8px; border-radius: 4px;">
            <div style="font-weight: bold; color: #1565c0;">üëç Bon (3.5-4.5)</div>
            <div style="font-size: 14px; font-weight: bold;">{{ good_count }} fournisseurs</div>
            <div style="color: #666;">{{ good_percentage|floatformat:0 }}%</div>
        </div>
        <div style="background: #fff3e0; padding: 8px; border-radius: 4px;">
            <div style="font-weight: bold; color: #ef6c00;">‚ö†Ô∏è √Ä am√©liorer (<3.5)< /div>
                    <div style="font-size: 14px; font-weight: bold;">{{ poor_count }} fournisseurs</div>
                    <div style="color: #666;">{{ poor_percentage|floatformat:0 }}%</div>
            </div>
        </div>
    </div>

    {% if top_suppliers %}
    <div class="section" style="margin-bottom: 15px;">
        <h2 class="section-title">üè¢ Top 10 Fournisseurs (Volume)</h2>
        <table style="font-size: 10px;">
            <thead>
                <tr>
                    <th style="width: 40%;">Fournisseur</th>
                    <th class="text-center" style="width: 10%;">Note</th>
                    <th class="text-center" style="width: 15%;">Commandes</th>
                    <th class="text-right" style="width: 20%;">Volume</th>
                    <th class="text-right" style="width: 15%;">%</th>
                </tr>
            </thead>
            <tbody>
                {% for supplier in top_suppliers|slice:":10" %}
                <tr>
                    <td><strong>{{ supplier.name|truncatewords:5 }}</strong></td>
                    <td class="text-center">{{ supplier.rating|floatformat:1 }} ‚≠ê</td>
                    <td class="text-center">{{ supplier.po_count }}</td>
                    <td class="text-right">{{ supplier.volume|floatformat:2 }} {{ organization.currency|default:"CAD" }}
                    </td>
                    <td class="text-right">{{ supplier.percentage|floatformat:1 }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div
            style="background: {% if concentration_risk %}#ffebee{% else %}#f5f5f5{% endif %}; padding: 6px; margin-top: 8px; font-size: 10px; border-radius: 3px;">
            <strong>{% if concentration_risk %}‚ö†Ô∏è Concentration:{% else %}Concentration:{% endif %}</strong> Top 5 = {{
            top5_percentage|floatformat:1 }}%
            {% if concentration_risk %}(risque de d√©pendance){% endif %}
        </div>
    </div>
    {% endif %}

    <div class="section" style="margin-bottom: 15px;">
        <h2 class="section-title">üåç Diversit√© & RSE</h2>
        <div style="font-size: 10px;">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                <div>üè† <strong>Locaux:</strong> {{ local_count }} ({{ local_percentage|floatformat:0 }}%)</div>
                <div>üë• <strong>Minoritaires:</strong> {{ minority_count }} ({{ minority_percentage|floatformat:0 }}%)
                </div>
                <div>üë© <strong>F√©minins:</strong> {{ women_count }} ({{ women_percentage|floatformat:0 }}%)</div>
                <div>ü¶Ö <strong>Autochtones:</strong> {{ indigenous_count }} ({{ indigenous_percentage|floatformat:0
                    }}%)</div>
            </div>
        </div>
    </div>

    {% if inactive_count > 0 or concentration_risk %}
    <div class="section" style="margin-bottom: 15px;">
        <h2 class="section-title">‚ö†Ô∏è Risques & Alertes</h2>
        <div style="font-size: 10px;">
            {% if concentration_risk %}
            <div
                style="background: #ffebee; padding: 8px; margin-bottom: 5px; border-left: 3px solid #c62828; border-radius: 3px;">
                <strong style="color: #c62828;">‚ö†Ô∏è Concentration risqu√©e</strong>
                <div style="color: #666; margin-top: 3px;">‚Üí Top 5 = {{ top5_percentage|floatformat:0 }}% du volume
                    (diversifier)</div>
            </div>
            {% endif %}
            {% if inactive_count > 0 %}
            <div style="background: #f5f5f5; padding: 8px; border-left: 3px solid #666; border-radius: 3px;">
                <strong style="color: #666;">üí§ {{ inactive_count }} fournisseur(s) inactifs (90j+)</strong>
                <div style="color: #666; margin-top: 3px;">‚Üí Nettoyer la base ou r√©activer</div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- LISTE DES FOURNISSEURS (ESSENTIEL - GARD√â) -->
    <div class="section" style="margin-bottom: 15px;">
        <h2 class="section-title">üìã Liste des Fournisseurs</h2>
        <table style="font-size: 10px;">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Email</th>
                    <th>T√©l√©phone</th>
                    <th class="text-center">Note</th>
                    <th class="text-center">Statut</th>
                </tr>
            </thead>
            <tbody>
                {% for supplier in suppliers %}
                <tr>
                    <td><strong>{{ supplier.name|truncatewords:4 }}</strong></td>
                    <td>{{ supplier.email|default:"-" }}</td>
                    <td>{{ supplier.phone|default:"-" }}</td>
                    <td class="text-center">{{ supplier.rating|floatformat:1 }} ‚≠ê</td>
                    <td class="text-center">
                        {% if supplier.status == 'active' %}<span class="badge success">Actif</span>
                        {% elif supplier.status == 'pending' %}<span class="badge warning">En attente</span>
                        {% elif supplier.status == 'blocked' %}<span class="badge danger">Bloqu√©</span>
                        {% else %}<span class="badge info">{{ supplier.status }}</span>{% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center; color: #999;">Aucun fournisseur</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="highlight-box" style="font-size: 10px;">
        <strong style="font-size: 11px;">üìù R√©sum√© Ex√©cutif</strong>
        <div style="margin-top: 6px; line-height: 1.5;">
            <strong>{{ total_count }} fournisseurs</strong> ({{ active_count }} actifs).
            Volume: <strong>{{ total_volume|floatformat:2 }} {{ organization.currency|default:"CAD" }}</strong>.
            Note moyenne: <strong>{{ avg_rating|floatformat:1 }}/5.0 ‚≠ê</strong>.
            Diversit√©: {{ local_percentage|floatformat:0 }}% locaux.
            {% if concentration_risk %}‚ö†Ô∏è Concentration √† surveiller.{% endif %}
        </div>
    </div>

    {% endblock %}