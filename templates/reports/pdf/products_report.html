{% extends "reports/pdf/base_report.html" %}

{% block title %}Rapport des Produits{% endblock %}

{% block report_title %}üì¶ Rapport des Produits{% endblock %}
{% block report_subtitle %}
    {% if date_start or date_end %}
        P√©riode: {% if date_start %}{{ date_start|date:"d/m/Y" }}{% else %}D√©but{% endif %} - {% if date_end %}{{ date_end|date:"d/m/Y" }}{% else %}Aujourd'hui{% endif %}
    {% endif %}
    ‚Ä¢ {{ total_count }} produit(s) ‚Ä¢ G√©n√©r√© le {{ generated_at|date:"d/m/Y √† H:i" }}
{% endblock %}

{% block content %}

<div class="stats-grid" style="margin-bottom: 15px;">
    <div class="stat-card primary">
        <div class="label">Total Produits</div>
        <div class="value">{{ total_count }}</div>
        <div class="subvalue">{{ active_count }} actifs ({{ active_percentage|floatformat:0 }}%)</div>
    </div>
    <div class="stat-card success">
        <div class="label">Valeur Stock</div>
        <div class="value">{{ stock_value|floatformat:2 }}</div>
        <div class="subvalue">{{ organization.currency|default:"CAD" }}</div>
    </div>
    <div class="stat-card warning">
        <div class="label">Marge Moyenne</div>
        <div class="value">{{ avg_margin|floatformat:1 }}%</div>
        <div class="subvalue">Rentabilit√©</div>
    </div>
    <div class="stat-card {% if rotation_rate >= 3 %}success{% else %}warning{% endif %}">
        <div class="label">Taux Rotation</div>
        <div class="value">{{ rotation_rate|floatformat:1 }}</div>
        <div class="subvalue">Par an</div>
    </div>
</div>

{% if top_products %}
<div class="section" style="margin-bottom: 15px;">
    <h2 class="section-title">üèÜ Top 10 Produits (CA)</h2>
    <table style="font-size: 10px;">
        <thead>
            <tr><th style="width: 45%;">Produit</th><th class="text-center" style="width: 15%;">Qt√©</th><th class="text-right" style="width: 25%;">CA</th><th class="text-right" style="width: 15%;">%</th></tr>
        </thead>
        <tbody>
            {% for product in top_products|slice:":10" %}
            <tr>
                <td><strong>{{ product.name|truncatewords:5 }}</strong></td>
                <td class="text-center">{{ product.quantity_sold }}</td>
                <td class="text-right">{{ product.revenue|floatformat:2 }} {{ organization.currency|default:"CAD" }}</td>
                <td class="text-right">{{ product.percentage|floatformat:1 }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div class="section" style="margin-bottom: 15px;">
    <h2 class="section-title">üìä √âtat du Stock (Physiques)</h2>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 11px;">
        <div style="background: #ffebee; padding: 8px; border-radius: 4px;">
            <div style="font-weight: bold; color: #c62828;">üî¥ Ruptures</div>
            <div style="font-size: 14px; font-weight: bold;">{{ out_of_stock_count }}</div>
        </div>
        <div style="background: #fff3e0; padding: 8px; border-radius: 4px;">
            <div style="font-weight: bold; color: #ef6c00;">‚ö†Ô∏è Stock Bas</div>
            <div style="font-size: 14px; font-weight: bold;">{{ low_stock_count }}</div>
        </div>
        <div style="background: #f5f5f5; padding: 8px; border-radius: 4px;">
            <div style="font-weight: bold; color: #666;">üí§ Sans Vente</div>
            <div style="font-size: 14px; font-weight: bold;">{{ no_sales_count }}</div>
        </div>
    </div>
</div>

{% if out_of_stock_count > 0 or low_stock_count > 0 or dormant_stock_value > 0 %}
<div class="section" style="margin-bottom: 15px;">
    <h2 class="section-title">‚ö†Ô∏è Alertes Stock</h2>
    <div style="font-size: 10px;">
        {% if out_of_stock_count > 0 %}
        <div style="background: #ffebee; padding: 8px; margin-bottom: 5px; border-left: 3px solid #c62828; border-radius: 3px;">
            <strong style="color: #c62828;">üî¥ {{ out_of_stock_count }} produit(s) en rupture</strong>
            <div style="color: #666; margin-top: 3px;">‚Üí R√©approvisionnement urgent</div>
        </div>
        {% endif %}
        {% if low_stock_count > 0 %}
        <div style="background: #fff3e0; padding: 8px; margin-bottom: 5px; border-left: 3px solid #ef6c00; border-radius: 3px;">
            <strong style="color: #ef6c00;">‚ö†Ô∏è {{ low_stock_count }} produit(s) en stock bas</strong>
            <div style="color: #666; margin-top: 3px;">‚Üí Commander prochainement</div>
        </div>
        {% endif %}
        {% if dormant_stock_value > 0 %}
        <div style="background: #f5f5f5; padding: 8px; border-left: 3px solid #666; border-radius: 3px;">
            <strong style="color: #666;">üí§ Stock dormant: {{ dormant_stock_value|floatformat:2 }} {{ organization.currency|default:"CAD" }}</strong>
            <div style="color: #666; margin-top: 3px;">‚Üí {{ no_sales_count }} produits sans vente (180j+)</div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- LISTE DES PRODUITS (ESSENTIEL - GARD√â) -->
<div class="section" style="margin-bottom: 15px;">
    <h2 class="section-title">üìã Liste des Produits</h2>
    <table style="font-size: 10px;">
        <thead>
            <tr>
                <th>Nom</th>
                <th>R√©f√©rence</th>
                <th class="text-center">Type</th>
                <th class="text-right">Prix</th>
                <th class="text-right">Stock</th>
                <th class="text-center">Statut</th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}
            <tr>
                <td><strong>{{ product.name|truncatewords:4 }}</strong></td>
                <td>{{ product.reference|default:"-" }}</td>
                <td class="text-center">{{ product.get_product_type_display|default:"-" }}</td>
                <td class="text-right">{{ product.price|floatformat:2 }} {{ organization.currency|default:"CAD" }}</td>
                <td class="text-right">
                    {% if product.product_type == 'physical' %}
                        {{ product.stock_quantity }}
                    {% else %}-{% endif %}
                </td>
                <td class="text-center">
                    {% if product.is_active %}<span class="badge success">Actif</span>
                    {% else %}<span class="badge info">Inactif</span>{% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" style="text-align: center; color: #999;">Aucun produit</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="highlight-box" style="font-size: 10px;">
    <strong style="font-size: 11px;">üìù R√©sum√© Ex√©cutif</strong>
    <div style="margin-top: 6px; line-height: 1.5;">
        <strong>{{ total_count }} produits</strong> ({{ active_count }} actifs).
        Valeur stock: <strong>{{ stock_value|floatformat:2 }} {{ organization.currency|default:"CAD" }}</strong>.
        Marge moyenne: <strong>{{ avg_margin|floatformat:1 }}%</strong>.
        {% if out_of_stock_count > 0 %}‚ö†Ô∏è {{ out_of_stock_count }} ruptures.{% endif %}
        {% if low_stock_count > 0 %}‚ö†Ô∏è {{ low_stock_count }} en stock bas.{% endif %}
    </div>
</div>

{% endblock %}
