<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CSJ - CENTRE DE SANTE JULIANNA{% endblock %}</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Theme principal -->
    {% load static %}
    <link href="{% static 'css/theme.css' %}" rel="stylesheet">
    <link href="{% static 'css/admin.css' %}" rel="stylesheet">
    <link href="{% static 'css/mobile-improvements.css' %}" rel="stylesheet">
    <!-- CSS principal -->
    <link href="{% static 'css/main.css' %}" rel="stylesheet">

    {% block extra_css %}{% endblock %}

    <!-- Meta tags pour PWA -->
    <meta name="theme-color" content="#0066cc">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="CSJ">
</head>

<body>
    <!-- Navigation Desktop -->
    <nav class="navbar navbar-expand-lg desktop-navbar d-none d-md-flex">
        <div class="container-fluid">
            <a class="navbar-brand hover-scale" href="{% url 'core:home' %}">
                <i class="bi bi-gem"></i>
                CSJ
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    {% if user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}"
                            href="{% url 'core:dashboard' %}">
                            <i class="bi bi-speedometer2 me-1"></i> Tableau de bord
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="suppliers-link">
                            <i class="bi bi-building me-1"></i> Fournisseurs
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="orders-link">
                            <i class="bi bi-cart-check me-1"></i> Commandes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="invoices-link">
                            <i class="bi bi-receipt me-1"></i> Factures
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="analytics-link">
                            <i class="bi bi-graph-up me-1"></i> Analytics
                        </a>
                    </li>
                    {% endif %}
                </ul>

                <ul class="navbar-nav">
                    {% if user.is_authenticated %}
                    <!-- IA Assistant Button -->
                    <li class="nav-item">
                        <button class="btn btn-outline-light btn-sm me-2" id="ai-assistant-toggle">
                            <i class="bi bi-robot me-1"></i> IA Assistant
                        </button>
                    </li>

                    <!-- Notifications -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle position-relative" href="#" id="notificationsDropdown"
                            role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-bell"></i>
                            <span
                                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                3
                            </span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" style="width: 300px;">
                            <li>
                                <h6 class="dropdown-header">Notifications</h6>
                            </li>
                            <li><a class="dropdown-item" href="#">
                                    <small class="text-muted">Il y a 5 min</small><br>
                                    Nouveau bon de commande approuv√©
                                </a></li>
                            <li><a class="dropdown-item" href="#">
                                    <small class="text-muted">Il y a 1h</small><br>
                                    Facture en attente de validation
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-center" href="#">Voir toutes les notifications</a></li>
                        </ul>
                    </li>

                    <!-- User Menu -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown"
                            role="button" data-bs-toggle="dropdown">
                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-2"
                                style="width: 32px; height: 32px;">
                                <i class="bi bi-person text-primary"></i>
                            </div>
                            {{ user.first_name|default:user.username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/accounts/profile/">
                                    <i class="bi bi-person me-2"></i>Mon Profil
                                </a></li>
                            <li><a class="dropdown-item" href="#">
                                    <i class="bi bi-gear me-2"></i>Param√®tres
                                </a></li>
                            <li><a class="dropdown-item" href="/admin/">
                                    <i class="bi bi-shield-check me-2"></i>Administration
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="/accounts/logout/">
                                    <i class="bi bi-box-arrow-right me-2"></i>D√©connexion
                                </a></li>
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="btn btn-outline-light me-2" href="{% url 'accounts:login' %}">
                            <i class="bi bi-box-arrow-in-right me-1"></i> Connexion
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Mobile Tab Bar -->
    {% if user.is_authenticated %}
    <div class="mobile-tab-bar d-flex d-md-none">
        <a href="{% url 'core:dashboard' %}"
            class="mobile-tab-item {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
            <i class="bi bi-house tab-icon"></i>
            <span class="tab-label">App</span>
        </a>
        <a href="#" class="mobile-tab-item" id="mobile-suppliers">
            <i class="bi bi-building tab-icon"></i>
            <span class="tab-label">Fournisseurs</span>
        </a>
        <button class="mobile-tab-item" id="mobile-ai-toggle">
            <i class="bi bi-robot tab-icon"></i>
            <span class="tab-label">IA</span>
        </button>
        <a href="#" class="mobile-tab-item" id="mobile-orders">
            <i class="bi bi-cart-check tab-icon"></i>
            <span class="tab-label">Commandes</span>
        </a>
        <a href="#" class="mobile-tab-item" id="mobile-menu">
            <i class="bi bi-list tab-icon"></i>
            <span class="tab-label">Menu</span>
        </a>
    </div>
    {% endif %}

    <!-- Messages Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;">
        {% if messages %}
        {% for message in messages %}
        <div class="toast show fade-in" role="alert" data-bs-autohide="true" data-bs-delay="5000">
            <div class="toast-header">
                <div class="rounded me-2 d-flex align-items-center justify-content-center"
                    style="width: 20px; height: 20px; background: var(--gradient-primary);">
                    <i class="bi bi-check-circle text-white" style="font-size: 0.75rem;"></i>
                </div>
                <strong class="me-auto">CSJ</strong>
                <small class="text-muted">√Ä l'instant</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                {{ message }}
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>

    <!-- IA Assistant Modal -->
    <div class="modal fade" id="aiAssistantModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-gradient">
                    <h5 class="modal-title text-white">
                        <i class="bi bi-robot me-2"></i>Assistant IA CSJ
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="ai-chat-container">
                        <div class="ai-chat-messages" id="ai-chat-messages">
                            <div class="ai-message assistant">
                                <strong>Assistant IA:</strong><br>
                                Bonjour ! Je suis votre assistant IA pour CSJ.
                                Je peux vous aider avec vos fournisseurs, commandes, factures et analyses.
                                Que puis-je faire pour vous aujourd'hui ?
                            </div>
                        </div>
                        <div class="ai-chat-input">
                            <form class="ai-chat-form d-flex gap-2">
                                <input type="text" class="form-control" placeholder="Tapez votre message ici..."
                                    id="ai-chat-input">
                                <button type="submit" class="btn btn-primary ai-chat-send">
                                    <i class="bi bi-send"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        L'IA peut analyser vos donn√©es et sugg√©rer des actions automatis√©es.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container-fluid">
            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- Footer Modern -->
    <footer class="mt-auto py-4 d-none d-md-block" style="background: var(--gradient-primary-dark); color: white;">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-gem me-2" style="font-size: 1.5rem;"></i>
                        <h5 class="mb-0 text-gradient-white">CSJ</h5>
                    </div>
                    <p class="mb-0 opacity-75">
                        Solution IA compl√®te de gestion des approvisionnements
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="d-flex justify-content-md-end gap-3 mb-2">
                        <a href="#" class="text-white-50 hover-scale">
                            <i class="bi bi-question-circle"></i> Aide
                        </a>
                        <a href="#" class="text-white-50 hover-scale">
                            <i class="bi bi-shield-check"></i> S√©curit√©
                        </a>
                        <a href="#" class="text-white-50 hover-scale">
                            <i class="bi bi-envelope"></i> Contact
                        </a>
                    </div>
                    <small class="opacity-75">
                        Version 2.0 - Interface Hybride IA + Manuel
                    </small>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/main.js' %}"></script>
    <script src="{% static 'js/forms.js' %}"></script>
    <script src="{% static 'js/mobile.js' %}"></script>
    <script src="{% static 'js/inline-editing.js' %}"></script>
    <script src="{% static 'js/components.js' %}"></script>

    <script>
        // ====================================
        // üé≠ INTERACTIONS MODERNES
        // ====================================

        document.addEventListener('DOMContentLoaded', function () {
            // Toast auto-initialization
            const toastElements = document.querySelectorAll('.toast');
            toastElements.forEach(toastElement => {
                const toast = new bootstrap.Toast(toastElement);
                toast.show();
            });

            // IA Assistant Modal
            const aiToggleButtons = document.querySelectorAll('#ai-assistant-toggle, #mobile-ai-toggle');
            const aiModal = new bootstrap.Modal(document.getElementById('aiAssistantModal'));

            aiToggleButtons.forEach(button => {
                button.addEventListener('click', () => {
                    aiModal.show();
                });
            });

            // Mobile menu interactions
            const mobileMenuItems = document.querySelectorAll('.mobile-tab-item');
            mobileMenuItems.forEach(item => {
                item.addEventListener('click', function () {
                    // Remove active class from all items
                    mobileMenuItems.forEach(i => i.classList.remove('active'));
                    // Add active class to clicked item
                    this.classList.add('active');
                });
            });

            // Smooth scrolling for anchor links
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });

            // Lazy loading animations
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('fade-in');
                        observer.unobserve(entry.target);
                    }
                });
            }, observerOptions);

            document.querySelectorAll('.card, .stat-card, .form-section').forEach(el => {
                observer.observe(el);
            });

            // Enhanced button interactions
            document.querySelectorAll('.btn').forEach(button => {
                button.addEventListener('click', function (e) {
                    // Create ripple effect
                    const ripple = document.createElement('span');
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;

                    ripple.style.width = ripple.style.height = size + 'px';
                    ripple.style.left = x + 'px';
                    ripple.style.top = y + 'px';
                    ripple.classList.add('ripple');

                    this.appendChild(ripple);

                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                });
            });

            // Form enhancements
            document.querySelectorAll('.form-control, .form-select').forEach(input => {
                input.addEventListener('focus', function () {
                    this.parentElement.classList.add('form-group-focused');
                });

                input.addEventListener('blur', function () {
                    this.parentElement.classList.remove('form-group-focused');
                });
            });

            // Inline editing functionality
            document.querySelectorAll('.inline-edit').forEach(editableElement => {
                editableElement.addEventListener('dblclick', function () {
                    const currentText = this.textContent;
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = currentText;
                    input.className = 'inline-edit-field';

                    this.innerHTML = '';
                    this.appendChild(input);
                    input.focus();
                    input.select();

                    input.addEventListener('blur', saveEdit);
                    input.addEventListener('keydown', function (e) {
                        if (e.key === 'Enter') {
                            saveEdit();
                        } else if (e.key === 'Escape') {
                            cancelEdit();
                        }
                    });

                    function saveEdit() {
                        const newValue = input.value;
                        editableElement.textContent = newValue;
                        // Ici vous pouvez ajouter la logique AJAX pour sauvegarder
                        console.log('Saved:', newValue);
                    }

                    function cancelEdit() {
                        editableElement.textContent = currentText;
                    }
                });
            });

            // Enhanced search with debouncing
            const searchInputs = document.querySelectorAll('input[type="search"], input[name*="search"]');
            searchInputs.forEach(input => {
                let timeoutId;
                input.addEventListener('input', function () {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        // Trigger search
                        console.log('Searching for:', this.value);
                        // Add your search logic here
                    }, 300);
                });
            });

            // Progressive Web App features
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/static/js/sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            }

            // Keyboard shortcuts
            document.addEventListener('keydown', function (e) {
                // Alt + A = IA Assistant
                if (e.altKey && e.key === 'a') {
                    e.preventDefault();
                    aiModal.show();
                }

                // Alt + S = Search focus
                if (e.altKey && e.key === 's') {
                    e.preventDefault();
                    const searchInput = document.querySelector('input[type="search"]');
                    if (searchInput) {
                        searchInput.focus();
                    }
                }
            });
        });

        // ====================================
        // üé® UTILITY FUNCTIONS
        // ====================================

        // Show success toast
        window.showSuccessToast = function (message) {
            showToast(message, 'success');
        };

        // Show error toast
        window.showErrorToast = function (message) {
            showToast(message, 'danger');
        };

        // Generic toast function
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastHtml = `
                <div class="toast fade-in" role="alert" data-bs-autohide="true" data-bs-delay="5000">
                    <div class="toast-header">
                        <div class="rounded me-2 d-flex align-items-center justify-content-center" 
                             style="width: 20px; height: 20px; background: var(--gradient-primary);">
                            <i class="bi bi-check-circle text-white" style="font-size: 0.75rem;"></i>
                        </div>
                        <strong class="me-auto">CSJ</strong>
                        <small class="text-muted">√Ä l'instant</small>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">${message}</div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const newToast = toastContainer.lastElementChild;
            const toast = new bootstrap.Toast(newToast);
            toast.show();
        }

        // Enhanced loading states
        window.setLoadingState = function (element, loading = true, text = 'Chargement...') {
            if (loading) {
                element.disabled = true;
                element.dataset.originalText = element.textContent;
                element.innerHTML = `
                    <div class="d-flex align-items-center justify-content-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        ${text}
                    </div>
                `;
            } else {
                element.disabled = false;
                element.textContent = element.dataset.originalText || 'Valider';
            }
        };

        // Format currency
        window.formatCurrency = function (amount, currency = 'CAD') {
            return new Intl.NumberFormat('fr-CA', {
                style: 'currency',
                currency: currency
            }).format(amount);
        };
    </script>

    {% block extra_js %}{% endblock %}
</body>

</html>