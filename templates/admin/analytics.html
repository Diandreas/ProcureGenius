{% extends 'admin/base_admin.html' %}
{% load i18n static %}

{% block title %}{% trans "Analytics" %} - Admin{% endblock %}

{% block admin_content %}
<div class="admin-header">
    <h1>{% trans "Analytics et Rapports" %}</h1>
    <div class="header-actions">
        <div class="period-selector">
            <label for="period">{% trans "PÃ©riode:" %}</label>
            <select id="period" onchange="changePeriod(this.value)">
                <option value="7" {% if period == '7' %}selected{% endif %}>7 {% trans "jours" %}</option>
                <option value="30" {% if period == '30' %}selected{% endif %}>30 {% trans "jours" %}</option>
                <option value="90" {% if period == '90' %}selected{% endif %}>90 {% trans "jours" %}</option>
                <option value="365" {% if period == '365' %}selected{% endif %}>1 {% trans "an" %}</option>
            </select>
        </div>
    </div>
</div>

<!-- KPIs principaux -->
<div class="kpi-grid">
    <div class="kpi-card">
        <div class="kpi-icon">ðŸ’°</div>
        <div class="kpi-info">
            <h3>{{ current_period_total|floatformat:2 }} CAD</h3>
            <p>{% trans "Revenus pÃ©riode" %}</p>
            <div class="kpi-trend {% if growth_rate >= 0 %}positive{% else %}negative{% endif %}">
                {% if growth_rate >= 0 %}ðŸ“ˆ{% else %}ðŸ“‰{% endif %}
                {{ growth_rate }}%
            </div>
        </div>
    </div>

    <div class="kpi-card">
        <div class="kpi-icon">ðŸ“Š</div>
        <div class="kpi-info">
            <h3>{{ previous_period_total|floatformat:2 }} CAD</h3>
            <p>{% trans "PÃ©riode prÃ©cÃ©dente" %}</p>
            <div class="kpi-comparison">
                {% trans "vs pÃ©riode actuelle" %}
            </div>
        </div>
    </div>

    <div class="kpi-card">
        <div class="kpi-icon">ðŸ“ˆ</div>
        <div class="kpi-info">
            <h3>{{ growth_rate|floatformat:1 }}%</h3>
            <p>{% trans "Croissance" %}</p>
            <div class="kpi-period">
                {{ start_date|date:"d/m" }} - {{ end_date|date:"d/m" }}
            </div>
        </div>
    </div>
</div>

<!-- Graphiques -->
<div class="charts-container">
    <div class="chart-card large">
        <div class="chart-header">
            <h3>{% trans "Ã‰volution des Revenus" %}</h3>
            <div class="chart-legend">
                <span class="legend-item invoices">ðŸ“„ {% trans "Factures" %}</span>
                <span class="legend-item purchase-orders">ðŸ“‹ {% trans "Commandes" %}</span>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="revenueChart" width="800" height="300"></canvas>
        </div>
    </div>

    <div class="chart-card">
        <div class="chart-header">
            <h3>{% trans "RÃ©partition par Type" %}</h3>
        </div>
        <div class="chart-container">
            <canvas id="typeChart" width="400" height="300"></canvas>
        </div>
    </div>
</div>

<!-- Top Fournisseurs -->
<div class="suppliers-section">
    <div class="section-header">
        <h3>{% trans "Top Fournisseurs" %}</h3>
        <span class="section-subtitle">{% trans "ClassÃ©s par volume de commandes" %}</span>
    </div>

    <div class="suppliers-list">
        {% for supplier in top_suppliers %}
        <div class="supplier-item">
            <div class="supplier-rank">{{ forloop.counter }}</div>
            <div class="supplier-info">
                <h4>{{ supplier.name }}</h4>
                <p>{{ supplier.po_count }} commande{{ supplier.po_count|pluralize }}</p>
            </div>
            <div class="supplier-amount">
                <strong>{{ supplier.po_total|floatformat:2 }} CAD</strong>
            </div>
            <div class="supplier-progress">
                <div class="progress-bar" style="width: {% widthratio supplier.po_total top_suppliers.0.po_total 100 %}%"></div>
            </div>
        </div>
        {% empty %}
        <div class="no-data">
            {% trans "Aucun fournisseur trouvÃ© pour cette pÃ©riode." %}
        </div>
        {% endfor %}
    </div>
</div>

<!-- Tableaux de donnÃ©es dÃ©taillÃ©es -->
<div class="data-tables">
    <div class="table-card">
        <h3>{% trans "Performances par Mois" %}</h3>
        <div class="table-container">
            <table class="analytics-table">
                <thead>
                    <tr>
                        <th>{% trans "Mois" %}</th>
                        <th>{% trans "Factures" %}</th>
                        <th>{% trans "Commandes" %}</th>
                        <th>{% trans "Total" %}</th>
                        <th>{% trans "Tendance" %}</th>
                    </tr>
                </thead>
                <tbody id="monthlyData">
                    <!-- Les donnÃ©es seront ajoutÃ©es par JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <div class="table-card">
        <h3>{% trans "Statistiques DÃ©taillÃ©es" %}</h3>
        <div class="stats-details">
            <div class="stat-detail">
                <span class="stat-label">{% trans "Facture moyenne" %}</span>
                <span class="stat-value">0 CAD</span>
            </div>
            <div class="stat-detail">
                <span class="stat-label">{% trans "Commande moyenne" %}</span>
                <span class="stat-value">0 CAD</span>
            </div>
            <div class="stat-detail">
                <span class="stat-label">{% trans "Jour le plus actif" %}</span>
                <span class="stat-value">Lundi</span>
            </div>
            <div class="stat-detail">
                <span class="stat-label">{% trans "Taux de conversion" %}</span>
                <span class="stat-value">85%</span>
            </div>
        </div>
    </div>
</div>

<style>
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.kpi-card {
    background: white;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 16px;
}

.kpi-icon {
    font-size: 32px;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
}

.kpi-info h3 {
    margin: 0 0 4px 0;
    font-size: 24px;
    font-weight: 600;
    color: #2c3e50;
}

.kpi-info p {
    margin: 0 0 8px 0;
    color: #7f8c8d;
    font-size: 14px;
}

.kpi-trend {
    font-size: 12px;
    font-weight: 500;
    padding: 4px 8px;
    border-radius: 4px;
}

.kpi-trend.positive {
    background-color: #e8f5e8;
    color: #388e3c;
}

.kpi-trend.negative {
    background-color: #ffebee;
    color: #d32f2f;
}

.charts-container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

.chart-card {
    background: white;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.chart-card.large {
    grid-column: span 2;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.chart-header h3 {
    margin: 0;
    color: #2c3e50;
}

.chart-legend {
    display: flex;
    gap: 16px;
}

.legend-item {
    font-size: 12px;
    color: #7f8c8d;
}

.chart-container {
    position: relative;
    height: 300px;
}

.suppliers-section {
    background: white;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin-bottom: 30px;
}

.section-header {
    margin-bottom: 20px;
}

.section-header h3 {
    margin: 0 0 4px 0;
    color: #2c3e50;
}

.section-subtitle {
    color: #7f8c8d;
    font-size: 14px;
}

.suppliers-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.supplier-item {
    display: grid;
    grid-template-columns: auto 1fr auto auto;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: #f8f9fa;
    border-radius: 8px;
}

.supplier-rank {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
}

.supplier-info h4 {
    margin: 0 0 4px 0;
    color: #2c3e50;
}

.supplier-info p {
    margin: 0;
    color: #7f8c8d;
    font-size: 12px;
}

.supplier-amount {
    text-align: right;
}

.supplier-progress {
    width: 100px;
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    transition: width 0.3s ease;
}

.data-tables {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
}

.table-card {
    background: white;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.table-card h3 {
    margin: 0 0 20px 0;
    color: #2c3e50;
}

.analytics-table {
    width: 100%;
    border-collapse: collapse;
}

.analytics-table th,
.analytics-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
}

.analytics-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #495057;
    font-size: 12px;
    text-transform: uppercase;
}

.stats-details {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.stat-detail {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #e9ecef;
}

.stat-label {
    color: #7f8c8d;
    font-size: 14px;
}

.stat-value {
    font-weight: 600;
    color: #2c3e50;
}

.period-selector {
    display: flex;
    align-items: center;
    gap: 8px;
}

.period-selector label {
    font-size: 14px;
    color: #7f8c8d;
}

.period-selector select {
    padding: 6px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}

@media (max-width: 768px) {
    .charts-container {
        grid-template-columns: 1fr;
    }

    .chart-card.large {
        grid-column: span 1;
    }

    .data-tables {
        grid-template-columns: 1fr;
    }

    .kpi-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// DonnÃ©es pour les graphiques
const invoicesData = {{ invoices_data|safe }};
const posData = {{ pos_data|safe }};

// Configuration des graphiques
document.addEventListener('DOMContentLoaded', function() {
    // Graphique des revenus
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: invoicesData.map(item => new Date(item.date).toLocaleDateString()),
            datasets: [{
                label: 'Factures',
                data: invoicesData.map(item => item.total),
                borderColor: '#0066cc',
                backgroundColor: 'rgba(0, 102, 204, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Commandes',
                data: posData.map(item => item.total),
                borderColor: '#00d4ff',
                backgroundColor: 'rgba(0, 212, 255, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + ' CAD';
                        }
                    }
                }
            }
        }
    });

    // Graphique en secteurs
    const typeCtx = document.getElementById('typeChart').getContext('2d');
    const totalInvoices = invoicesData.reduce((sum, item) => sum + item.total, 0);
    const totalPOs = posData.reduce((sum, item) => sum + item.total, 0);

    new Chart(typeCtx, {
        type: 'doughnut',
        data: {
            labels: ['Factures', 'Commandes'],
            datasets: [{
                data: [totalInvoices, totalPOs],
                backgroundColor: ['#0066cc', '#00d4ff'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
});

function changePeriod(period) {
    window.location.href = `?period=${period}`;
}
</script>
{% endblock %}