{% load i18n %}{% load invoice_filters %}<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE|default:'fr' }}">
<head>
    <meta charset="UTF-8">
    <title>Facture {{ invoice.invoice_number }}</title>
    <style>
        @page {
            {% if paper_size == 'thermal_58' %}
            size: 58mm 297mm;
            margin: 3mm 2mm;
            {% else %}
            size: 80mm 297mm;
            margin: 5mm 3mm;
            {% endif %}
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            font-size: 8pt;
            line-height: 1.3;
            color: #000;
            text-align: center;
        }

        .header {
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px dashed #000;
        }

        .company-name {
            font-size: 10pt;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .company-details {
            font-size: 7pt;
            line-height: 1.4;
        }

        .doc-info {
            margin: 8px 0;
            padding: 5px 0;
            border-top: 1px dashed #000;
            border-bottom: 1px dashed #000;
            font-size: 7pt;
        }

        .doc-number {
            font-size: 9pt;
            font-weight: 700;
            margin-bottom: 3px;
        }

        .client-section {
            margin: 8px 0;
            font-size: 7pt;
            text-align: left;
            padding: 0 3px;
        }

        .client-label {
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .items-section {
            margin: 8px 0;
            text-align: left;
            font-size: 7pt;
        }

        .item-line {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px dotted #ccc;
        }

        .item-name {
            flex: 1;
            font-weight: 600;
            padding-right: 5px;
        }

        .item-qty {
            width: 20px;
            text-align: center;
        }

        .item-price {
            width: 45px;
            text-align: right;
        }

        .totals-section {
            margin: 8px 0;
            padding: 5px 0;
            border-top: 1px solid #000;
            font-size: 7pt;
        }

        .total-line {
            display: flex;
            justify-content: space-between;
            padding: 2px 3px;
        }

        .total-line.final {
            font-size: 10pt;
            font-weight: 700;
            margin-top: 3px;
            padding-top: 3px;
            border-top: 1px solid #000;
        }

        .footer {
            margin-top: 10px;
            padding-top: 5px;
            border-top: 1px dashed #000;
            font-size: 7pt;
        }

        .qr-code {
            margin: 8px auto;
            width: 50px;
            height: 50px;
        }

        .thank-you {
            font-size: 8pt;
            font-weight: 700;
            margin: 5px 0;
        }

        .logo {
            margin: 5px auto 8px auto;
            max-width: 60px;
            max-height: 60px;
            display: block;
        }
    </style>
</head>
<body>
    <!-- En-tête -->
    <div class="header">
        {% if logo_base64 %}
        <img src="{{ logo_base64 }}" alt="Logo" class="logo">
        {% endif %}
        <div class="company-name">
            {% if organization.name %}
                {{ organization.name }}
            {% else %}
                VOTRE ENTREPRISE
                <!-- DEBUG: organization.name is empty -->
            {% endif %}
        </div>
        <div class="company-details">
            {% if organization.address %}{{ organization.address }}<br>{% endif %}
            {% if organization.phone %}Tel: {{ organization.phone }}<br>{% endif %}
            {% if organization.email %}Email: {{ organization.email }}<br>{% endif %}
            {# Affichage conditionnel selon la région fiscale #}
            {% if organization.tax_region == 'cameroon' or organization.tax_region == 'ohada' %}
                {% if organization.niu %}NIU: {{ organization.niu }}<br>{% endif %}
                {% if organization.rc_number %}RC: {{ organization.rc_number }}<br>{% elif organization.rccm_number %}RCCM: {{ organization.rccm_number }}<br>{% endif %}
            {% elif organization.tax_region == 'eu' %}
                {% if organization.vat_number %}TVA: {{ organization.vat_number }}<br>{% endif %}
            {% elif organization.tax_region == 'canada' %}
                {% if organization.neq %}NEQ: {{ organization.neq }}<br>{% endif %}
                {% if organization.gst_number %}TPS/TVH: {{ organization.gst_number }}<br>{% endif %}
                {% if organization.qst_number %}TVQ: {{ organization.qst_number }}<br>{% endif %}
            {% elif organization.tax_region == 'usa' %}
                {% if organization.tax_number %}TIN: {{ organization.tax_number }}<br>{% endif %}
            {% endif %}
        </div>
    </div>

    <!-- Info document -->
    <div class="doc-info">
        <div class="doc-number">FACTURE {{ invoice.invoice_number }}</div>
        <div>Date: {{ issue_date|date:"d/m/Y H:i" }}</div>
        {% if invoice.status %}
        <div>Statut: {{ invoice.get_status_display }}</div>
        {% endif %}
    </div>

    <!-- Client (optionnel) -->
    {% if client %}
    <div class="client-section">
        <div class="client-label">Client:</div>
        <div>{{ client.name }}</div>
    </div>
    {% endif %}

    <!-- Articles -->
    <div class="items-section">
        {% for item in items %}
        <div class="item-line">
            <div class="item-name">
                {% if item.product and item.product.name %}
                    {{ item.product.name|truncatechars:25 }}
                {% else %}
                    {{ item.description|truncatechars:25 }}
                {% endif %}
            </div>
            <div class="item-qty">{{ item.quantity|floatformat:0 }}</div>
            <div class="item-price">{{ item.total_price|floatformat:2 }} {{ organization.currency|default:"CAD" }}</div>
        </div>
        {% if item.detailed_description %}
        <div style="font-size: 6.5pt; color: #666; padding-left: 3px; margin-top: -2px;">
            {{ item.detailed_description|truncatechars:40 }}
        </div>
        {% endif %}
        {% endfor %}
    </div>

    <!-- Totaux -->
    <div class="totals-section">
        <div class="total-line">
            <span>Sous-total:</span>
            <span>{{ subtotal|floatformat:2 }} {{ organization.currency|default:"CAD" }}</span>
        </div>
        {% if tax_amount > 0 %}
        <div class="total-line">
            <span>Taxes:</span>
            <span>{{ tax_amount|floatformat:2 }} {{ organization.currency|default:"CAD" }}</span>
        </div>
        {% endif %}
        <div class="total-line final">
            <span>TOTAL:</span>
            <span>{{ total_amount|floatformat:2 }} {{ organization.currency|default:"CAD" }}</span>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        {% if qr_code_base64 %}
        <div>
            <img src="{{ qr_code_base64 }}" alt="QR" class="qr-code">
        </div>
        {% endif %}

        <div class="thank-you">
            Merci de votre visite !
        </div>

        {% if organization.website %}
        <div>{{ organization.website }}</div>
        {% endif %}
    </div>
</body>
</html>
