{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load crispy_forms_tags %}

{% block title %}{{ title }} - {% trans "Fournisseurs" %} - {{ block.super }}{% endblock %}

{% block extra_css %}
{{ block.super }}
{% crispy_form_tags_css %}
<style>
    .form-wizard {
        background: white;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        overflow: hidden;
        margin: 2rem 0;
    }
    
    .form-wizard-header {
        background: var(--gradient-primary);
        color: white;
        padding: 2rem;
        text-align: center;
        position: relative;
    }
    
    .form-wizard-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 200px;
        height: 200px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }
    
    .form-section {
        background: white;
        border-radius: var(--radius-lg);
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow);
        border-left: 4px solid var(--primary-blue);
        transition: all var(--transition-normal);
        position: relative;
    }
    
    .form-section:hover {
        transform: translateX(4px);
        box-shadow: var(--shadow-lg);
    }
    
    .section-title {
        color: var(--primary-blue);
        font-weight: 700;
        font-size: 1.25rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .section-title i {
        width: 40px;
        height: 40px;
        background: var(--gradient-primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1rem;
    }
    
    .floating-label {
        position: relative;
        margin-bottom: 1.5rem;
    }
    
    .floating-label .form-control,
    .floating-label .form-select {
        padding: 1rem 0.75rem 0.5rem 0.75rem;
        border: 2px solid var(--gray-200);
        border-radius: var(--radius);
        background: transparent;
        transition: all var(--transition-fast);
    }
    
    .floating-label .form-control:focus,
    .floating-label .form-select:focus {
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        outline: none;
    }
    
    .floating-label label {
        position: absolute;
        top: 1rem;
        left: 0.75rem;
        font-size: 1rem;
        color: var(--gray-500);
        pointer-events: none;
        transition: all var(--transition-fast);
        background: white;
        padding: 0 0.25rem;
    }
    
    .floating-label .form-control:focus + label,
    .floating-label .form-control:not(:placeholder-shown) + label,
    .floating-label .form-select:focus + label,
    .floating-label .form-select:not([value=""]) + label {
        top: -0.5rem;
        left: 0.5rem;
        font-size: 0.75rem;
        color: var(--primary-blue);
        font-weight: 600;
    }
    
    .certification-tag {
        display: inline-flex;
        align-items: center;
        background: var(--gradient-primary);
        color: white;
        padding: 0.5rem 1rem;
        margin: 0.25rem;
        border-radius: var(--radius-xl);
        font-size: 0.875rem;
        font-weight: 500;
        transition: all var(--transition-fast);
    }
    
    .certification-tag:hover {
        transform: scale(1.05);
        box-shadow: var(--shadow);
    }
    
    .certification-tag .remove-cert {
        margin-left: 0.5rem;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all var(--transition-fast);
    }
    
    .certification-tag .remove-cert:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }
    
    .province-info {
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-top: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--gray-50);
        border-radius: var(--radius);
        border-left: 3px solid var(--info);
    }
    
    .form-actions {
        background: var(--gray-50);
        padding: 2rem;
        border-radius: var(--radius-lg);
        margin-top: 2rem;
        text-align: center;
    }
    
    .progress-indicator {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 2rem 0;
    }
    
    .progress-step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--gray-200);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 1rem;
        color: var(--gray-500);
        font-weight: 600;
        transition: all var(--transition-fast);
    }
    
    .progress-step.active {
        background: var(--gradient-primary);
        color: white;
        transform: scale(1.1);
    }
    
    .progress-step.completed {
        background: var(--success);
        color: white;
    }
    
    .progress-connector {
        width: 60px;
        height: 2px;
        background: var(--gray-200);
        transition: all var(--transition-fast);
    }
    
    .progress-connector.active {
        background: var(--gradient-primary);
    }
    
    .smart-suggestions {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin: 1rem 0;
        border-left: 4px solid var(--primary-cyan);
    }
    
    .suggestion-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        margin: 0.25rem 0;
        background: white;
        border-radius: var(--radius);
        cursor: pointer;
        transition: all var(--transition-fast);
    }
    
    .suggestion-item:hover {
        background: var(--primary-blue);
        color: white;
        transform: translateX(4px);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>{{ title }}</h2>
            <a href="{% if supplier %}{% url 'suppliers:detail' supplier.pk %}{% else %}{% url 'suppliers:list' %}{% endif %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>
                {% trans "Retour" %}
            </a>
        </div>
        
        <form method="post" enctype="multipart/form-data" id="supplier-form">
            {% csrf_token %}
            
            <!-- Informations générales -->
            <div class="form-section">
                <h4 class="section-title">
                    <i class="bi bi-building me-2"></i>
                    {% trans "Informations générales" %}
                </h4>
                
                <div class="row">
                    <div class="col-md-8">
                        {{ form.name|as_crispy_field }}
                    </div>
                    <div class="col-md-4">
                        {{ form.legal_name|as_crispy_field }}
                    </div>
                </div>
                
                {{ form.business_number|as_crispy_field }}
                <div class="province-info">
                    <small>
                        <i class="bi bi-info-circle me-1"></i>
                        {% trans "Le numéro d'entreprise canadien (15 chiffres) est optionnel mais recommandé." %}
                    </small>
                </div>
            </div>
            
            <!-- Contact -->
            <div class="form-section">
                <h4 class="section-title">
                    <i class="bi bi-person-lines-fill me-2"></i>
                    {% trans "Informations de contact" %}
                </h4>
                
                <div class="row">
                    <div class="col-md-6">
                        {{ form.contact_person|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.email|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        {{ form.phone|as_crispy_field }}
                    </div>
                    <div class="col-md-6">
                        {{ form.website|as_crispy_field }}
                    </div>
                </div>
            </div>
            
            <!-- Adresse -->
            <div class="form-section">
                <h4 class="section-title">
                    <i class="bi bi-geo-alt me-2"></i>
                    {% trans "Adresse" %}
                </h4>
                
                {{ form.address|as_crispy_field }}
                
                <div class="row">
                    <div class="col-md-6">
                        {{ form.city|as_crispy_field }}
                    </div>
                    <div class="col-md-3">
                        {{ form.province|as_crispy_field }}
                    </div>
                    <div class="col-md-3">
                        {{ form.postal_code|as_crispy_field }}
                    </div>
                </div>
                
                <div class="province-info">
                    <small>
                        <i class="bi bi-info-circle me-1"></i>
                        {% trans "Format du code postal canadien: A1A 1A1" %}
                    </small>
                </div>
            </div>
            
            <!-- Termes commerciaux -->
            <div class="form-section">
                <h4 class="section-title">
                    <i class="bi bi-credit-card me-2"></i>
                    {% trans "Termes commerciaux" %}
                </h4>
                
                <div class="row">
                    <div class="col-md-6">
                        {{ form.payment_terms|as_crispy_field }}
                        <div class="province-info">
                            <small>{% trans "Exemples: NET 30, NET 15, Comptant, 2/10 NET 30" %}</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        {{ form.currency|as_crispy_field }}
                    </div>
                </div>
                
                {{ form.categories|as_crispy_field }}
            </div>
            
            <!-- Diversité et certification -->
            <div class="form-section">
                <h4 class="section-title">
                    <i class="bi bi-award me-2"></i>
                    {% trans "Diversité et certification" %}
                </h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check mb-3">
                            {{ form.is_local }}
                            <label class="form-check-label" for="{{ form.is_local.id_for_label }}">
                                <strong>{{ form.is_local.label }}</strong>
                                <br><small class="text-muted">{% trans "Fournisseur local ou régional" %}</small>
                            </label>
                        </div>
                        
                        <div class="form-check mb-3">
                            {{ form.is_minority_owned }}
                            <label class="form-check-label" for="{{ form.is_minority_owned.id_for_label }}">
                                <strong>{{ form.is_minority_owned.label }}</strong>
                                <br><small class="text-muted">{% trans "Entreprise détenue par une minorité" %}</small>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check mb-3">
                            {{ form.is_indigenous }}
                            <label class="form-check-label" for="{{ form.is_indigenous.id_for_label }}">
                                <strong>{{ form.is_indigenous.label }}</strong>
                                <br><small class="text-muted">{% trans "Entreprise autochtone" %}</small>
                            </label>
                        </div>
                        
                        <div class="form-check mb-3">
                            {{ form.is_woman_owned }}
                            <label class="form-check-label" for="{{ form.is_woman_owned.id_for_label }}">
                                <strong>{{ form.is_woman_owned.label }}</strong>
                                <br><small class="text-muted">{% trans "Entreprise dirigée par une femme" %}</small>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Certifications -->
                <div class="mb-3">
                    <label class="form-label">
                        <strong>{% trans "Certifications" %}</strong>
                    </label>
                    <div id="certifications-display" class="mb-2">
                        <!-- Les certifications seront affichées ici -->
                    </div>
                    <div class="input-group">
                        <input type="text" class="form-control" id="new-certification" placeholder="{% trans 'Ajouter une certification (ex: ISO 9001, CSA)' %}">
                        <button type="button" class="btn btn-outline-primary" id="add-certification">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                    <div class="province-info mt-2">
                        <small>
                            <i class="bi bi-info-circle me-1"></i>
                            {% trans "Exemples: ISO 9001, ISO 14001, CSA, LEED, FSC, etc." %}
                        </small>
                    </div>
                </div>
                
                {{ form.certifications }}
            </div>
            
            <!-- Boutons d'action -->
            <div class="form-section">
                <div class="d-flex justify-content-between">
                    <a href="{% if supplier %}{% url 'suppliers:detail' supplier.pk %}{% else %}{% url 'suppliers:list' %}{% endif %}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle me-1"></i>
                        {% trans "Annuler" %}
                    </a>
                    
                    <div>
                        <button type="button" class="btn btn-outline-primary me-2" id="save-draft">
                            <i class="bi bi-file-earmark me-1"></i>
                            {% trans "Sauvegarder brouillon" %}
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>
                            {% if supplier %}{% trans "Modifier" %}{% else %}{% trans "Créer" %}{% endif %}
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% crispy_form_tags_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion des certifications
    let certifications = [];
    
    // Charger les certifications existantes si modification
    {% if supplier.certifications %}
    certifications = {{ supplier.certifications|safe }};
    {% endif %}
    
    function updateCertificationsDisplay() {
        const container = document.getElementById('certifications-display');
        container.innerHTML = '';
        
        certifications.forEach((cert, index) => {
            const tag = document.createElement('span');
            tag.className = 'certification-tag';
            tag.innerHTML = `
                ${cert}
                <span class="remove-cert" onclick="removeCertification(${index})">
                    <i class="bi bi-x"></i>
                </span>
            `;
            container.appendChild(tag);
        });
        
        // Mettre à jour le champ caché
        document.getElementById('id_certifications').value = JSON.stringify(certifications);
    }
    
    window.removeCertification = function(index) {
        certifications.splice(index, 1);
        updateCertificationsDisplay();
    };
    
    document.getElementById('add-certification').addEventListener('click', function() {
        const input = document.getElementById('new-certification');
        const value = input.value.trim();
        
        if (value && !certifications.includes(value)) {
            certifications.push(value);
            updateCertificationsDisplay();
            input.value = '';
        }
    });
    
    document.getElementById('new-certification').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('add-certification').click();
        }
    });
    
    // Initialiser l'affichage
    updateCertificationsDisplay();
    
    // Validation du code postal canadien
    const postalCodeInput = document.getElementById('id_postal_code');
    if (postalCodeInput) {
        postalCodeInput.addEventListener('input', function() {
            let value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            if (value.length > 3) {
                value = value.substring(0, 3) + ' ' + value.substring(3, 6);
            }
            this.value = value;
        });
    }
    
    // Validation du numéro d'entreprise
    const businessNumberInput = document.getElementById('id_business_number');
    if (businessNumberInput) {
        businessNumberInput.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '').substring(0, 15);
        });
    }
    
    // Formatage du téléphone
    const phoneInput = document.getElementById('id_phone');
    if (phoneInput) {
        phoneInput.addEventListener('input', function() {
            let value = this.value.replace(/[^0-9]/g, '');
            if (value.length >= 10) {
                value = value.substring(0, 3) + '-' + value.substring(3, 6) + '-' + value.substring(6, 10);
            }
            this.value = value;
        });
    }
    
    // Sauvegarde brouillon
    document.getElementById('save-draft').addEventListener('click', function() {
        const form = document.getElementById('supplier-form');
        const formData = new FormData(form);
        formData.append('save_draft', 'true');
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', '{% trans "Brouillon sauvegardé avec succès." %}');
            } else {
                showAlert('danger', '{% trans "Erreur lors de la sauvegarde." %}');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', '{% trans "Erreur de communication avec le serveur." %}');
        });
    });
    
    // Validation du formulaire
    document.getElementById('supplier-form').addEventListener('submit', function(e) {
        const requiredFields = ['name', 'contact_person', 'email', 'address', 'city', 'province'];
        let isValid = true;
        
        requiredFields.forEach(fieldName => {
            const field = document.getElementById(`id_${fieldName}`);
            if (field && !field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else if (field) {
                field.classList.remove('is-invalid');
            }
        });
        
        // Validation email
        const emailField = document.getElementById('id_email');
        if (emailField && emailField.value) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(emailField.value)) {
                emailField.classList.add('is-invalid');
                isValid = false;
            }
        }
        
        if (!isValid) {
            e.preventDefault();
            showAlert('danger', '{% trans "Veuillez corriger les erreurs dans le formulaire." %}');
            // Scroll vers le premier champ invalide
            const firstInvalid = document.querySelector('.is-invalid');
            if (firstInvalid) {
                firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstInvalid.focus();
            }
        }
    });
    
    // Auto-complétion intelligente
    const cityInput = document.getElementById('id_city');
    const provinceInput = document.getElementById('id_province');
    
    if (cityInput && provinceInput) {
        // Suggestions de villes par province (exemple simplifié)
        const citiesByProvince = {
            'QC': ['Montréal', 'Québec', 'Laval', 'Gatineau', 'Longueuil', 'Sherbrooke'],
            'ON': ['Toronto', 'Ottawa', 'Mississauga', 'Brampton', 'Hamilton', 'London'],
            'BC': ['Vancouver', 'Surrey', 'Burnaby', 'Richmond', 'Abbotsford', 'Victoria'],
            'AB': ['Calgary', 'Edmonton', 'Red Deer', 'Lethbridge', 'Medicine Hat'],
        };
        
        provinceInput.addEventListener('change', function() {
            const cities = citiesByProvince[this.value] || [];
            if (cities.length > 0 && !cityInput.value) {
                // Optionnel: suggérer des villes
                cityInput.setAttribute('placeholder', `Ex: ${cities.slice(0, 3).join(', ')}`);
            }
        });
    }
});
</script>
{% endblock %}