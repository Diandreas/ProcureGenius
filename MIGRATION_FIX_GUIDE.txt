================================================================================
       GUIDE RAPIDE - CORRECTION ERREUR DE MIGRATION
       Centre de Sant√© JULIANNA
================================================================================

ERREUR RENCONTR√âE:
------------------
django.db.migrations.exceptions.InconsistentMigrationHistory:
Migration patients.0001_initial is applied before its dependency
invoicing.0020_warehouse_is_default_and_more on database 'default'.


================================================================================
üöÄ SOLUTION RAPIDE (Copier-coller sur le serveur)
================================================================================

# Option 1: Script Python automatique (RECOMMAND√â)
cd /home/centrejulianna-appback/htdocs/appback.centrejulianna.com
source venv/bin/activate
python fix_migration_order.py

# Option 2: Une seule commande
python -c "import os, django; os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'saas_procurement.settings'); django.setup(); from django.db.migrations.recorder import MigrationRecorder; MigrationRecorder.Migration.objects.get_or_create(app='invoicing', name='0020_warehouse_is_default_and_more'); print('‚úÖ Migration corrig√©e!')" && python manage.py migrate

# Option 3: Script bash
chmod +x fix_migration_quick.sh
./fix_migration_quick.sh


================================================================================
üìù EXPLICATION DU PROBL√àME
================================================================================

Sur le serveur de production:
  ‚úì Migration patients.0001_initial - APPLIQU√âE
  ‚úó Migration invoicing.0020_warehouse_is_default_and_more - NON APPLIQU√âE

Mais patients.0001_initial D√âPEND de invoicing.0020 !

La migration 0020 ajoute simplement:
- Un champ "is_default" au mod√®le Warehouse
- Modifie le champ "header_address" de PrintTemplate


================================================================================
üîß CORRECTION MANUELLE (Si les scripts ne marchent pas)
================================================================================

√âtape 1: Acc√©der √† PostgreSQL
------------------------------
python manage.py dbshell

√âtape 2: Dans le shell SQL, ex√©cuter:
--------------------------------------
INSERT INTO django_migrations (app, name, applied)
VALUES ('invoicing', '0020_warehouse_is_default_and_more', NOW())
ON CONFLICT DO NOTHING;

-- V√©rifier que c'est ajout√©
SELECT app, name FROM django_migrations
WHERE app = 'invoicing' AND name LIKE '%0020%';

-- Quitter
\q

√âtape 3: Appliquer les migrations
----------------------------------
python manage.py migrate


================================================================================
‚úÖ V√âRIFICATION APR√àS CORRECTION
================================================================================

# V√©rifier l'√©tat des migrations
python manage.py showmigrations invoicing | grep 0020
python manage.py showmigrations patients | head -5

# Vous devriez voir:
invoicing
 ...
 [X] 0020_warehouse_is_default_and_more
 ...

patients
 [X] 0001_initial
 ...


================================================================================
üéØ √âTAPES COMPL√àTES DE D√âPLOIEMENT APR√àS CORRECTION
================================================================================

1. CORRIGER LES MIGRATIONS (ci-dessus)
   python fix_migration_order.py

2. APPLIQUER TOUTES LES MIGRATIONS
   python manage.py migrate

3. COLLECTER LES FICHIERS STATIQUES
   python manage.py collectstatic --noinput

4. CHARGER LES DONN√âES DE PRODUCTION
   python manage.py create_julianna_production_data --reset

5. D√âMARRER LE SERVEUR
   gunicorn saas_procurement.wsgi:application --config gunicorn_config.py


================================================================================
üìä COMPTES UTILISATEURS CR√â√âS
================================================================================

Apr√®s avoir charg√© les donn√©es:

Username             Email               Password        R√¥le
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
julianna_admin      admin@csj.cm        julianna2025    Administrateur
julianna_reception  reception@csj.cm    julianna2025    R√©ceptionniste
julianna_doctor     docteur@csj.cm      julianna2025    M√©decin
julianna_lab        labo@csj.cm         julianna2025    Technicien labo
julianna_pharmacist pharma@csj.cm       julianna2025    Pharmacien

‚ö†Ô∏è Changez tous les mots de passe apr√®s le d√©ploiement!


================================================================================
üÜò SI LE PROBL√àME PERSISTE
================================================================================

V√©rifier les services:
----------------------
sudo systemctl status postgresql
sudo systemctl status redis-server

Voir les logs:
--------------
tail -f logs/django.log
tail -f logs/gunicorn_error.log

Tester la connexion DB:
------------------------
python manage.py dbshell
SELECT current_database();
\q

Diagnostiquer les migrations:
------------------------------
python manage.py showmigrations
python manage.py check


================================================================================
‚ö†Ô∏è SOLUTION DE DERNIER RECOURS (R√©initialisation compl√®te)
================================================================================

‚ö†Ô∏è ATTENTION: Ceci supprime TOUTES LES DONN√âES!

# 1. SAUVEGARDER D'ABORD!
pg_dump -U julianna_user julianna_db > backup_avant_reset_$(date +%Y%m%d_%H%M%S).sql

# 2. Supprimer toutes les migrations
python manage.py dbshell
DELETE FROM django_migrations;
\q

# 3. R√©appliquer toutes les migrations
python manage.py migrate --fake-initial

# 4. Recharger les donn√©es
python manage.py create_julianna_production_data --reset


================================================================================
üìû SUPPORT
================================================================================

Centre de Sant√© JULIANNA
Email: contact@centrejulianna.com
T√©l√©phone: +237 233 XX XX XX

Documentation compl√®te:
- DEPLOYMENT_JULIANNA.md
- FIX_MIGRATION_README.md


================================================================================
üìÅ FICHIERS CR√â√âS POUR VOUS AIDER
================================================================================

‚úÖ fix_migration_order.py      - Script Python intelligent (RECOMMAND√â)
‚úÖ fix_migration_quick.sh       - Script bash rapide
‚úÖ FIX_MIGRATION_README.md      - Documentation d√©taill√©e
‚úÖ MIGRATION_FIX_GUIDE.txt      - Ce fichier (guide rapide)


================================================================================
Date: 2025-02-05
Application: ProcureGenius Healthcare
Organisation: Centre de Sant√© JULIANNA
================================================================================
